/*
This software has been approved for release by the U.S. Department of the Interior. Although the software has been subjected to rigorous review, the DOI reserves the right to update the software as needed pursuant to further analysis and review. No warranty, expressed or implied, is made by the DOI or the U.S. Government as to the functionality of the software and related material nor shall the fact of release constitute any such warranty. Furthermore, the software is released on condition that neither the DOI nor the U.S. Government shall be held liable for any damages resulting from its authorized or unauthorized use.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leaflet-draw"),require("leaflet.markercluster"),require("leaflet-timedimension/dist/leaflet.timedimension.src"),require("esri-leaflet"),require("jquery"),require("leaflet"),require("@geoplatform/client")):"function"==typeof define&&define.amd?define("@geoplatform/mapcore",["exports","leaflet-draw","leaflet.markercluster","leaflet-timedimension/dist/leaflet.timedimension.src","esri-leaflet","jquery","leaflet","@geoplatform/client"],t):t((e.geoplatform=e.geoplatform||{},e.geoplatform.mapcore={}),e.L.Draw,null,null,e.L.esri,e.jQuery,e.L,e.geoplatform.client)}(this,function(e,i,t,r,u,a,L,p){"use strict";var o=L.Control.extend({options:{position:"topleft",separate:!1,zoomControl:null,spinjs:!1,spin:{lines:7,length:3,width:3,radius:5,rotate:13,top:"83%"}},initialize:function(e){L.Util.setOptions(this,e),this._dataLoaders={},null!==this.options.zoomControl&&(this.zoomControl=this.options.zoomControl)},onAdd:function(e){this._addLayerListeners(e),this._addMapListeners(e),this.options.separate||this.zoomControl||(e.zoomControl?this.zoomControl=e.zoomControl:e.zoomsliderControl&&(this.zoomControl=e.zoomsliderControl));var t,i="leaflet-control-loading";return this.zoomControl&&!this.options.separate?(t=this.zoomControl._container,i+=" leaflet-bar-part-bottom leaflet-bar-part last"):t=L.DomUtil.create("div","leaflet-control-zoom leaflet-bar"),this._indicator=L.DomUtil.create("a",i,t),t},onRemove:function(e){this._removeLayerListeners(e),this._removeMapListeners(e)},removeFrom:function(e){return this.zoomControl&&!this.options.separate?(this._container.removeChild(this._indicator),this._map=null,this.onRemove(e),this):L.Control.prototype.remove.call(this)},addLoader:function(e){this._dataLoaders[e]=!0,this.updateIndicator()},removeLoader:function(e){delete this._dataLoaders[e],this.updateIndicator()},updateIndicator:function(){this.isLoading()?this._showIndicator():this._hideIndicator()},isLoading:function(){return 0<this._countLoaders()},_countLoaders:function(){var e,t=0;for(e in this._dataLoaders)this._dataLoaders.hasOwnProperty(e)&&t++;return t},_showIndicator:function(){L.DomUtil.addClass(this._indicator,"is-loading"),this.options.separate||this.zoomControl instanceof L.Control.Zoom&&L.DomUtil.removeClass(this.zoomControl._zoomOutButton,"leaflet-bar-part-bottom")},_hideIndicator:function(){L.DomUtil.removeClass(this._indicator,"is-loading"),this.options.separate||this.zoomControl instanceof L.Control.Zoom&&L.DomUtil.addClass(this.zoomControl._zoomOutButton,"leaflet-bar-part-bottom")},_handleLoading:function(e){this.addLoader(this.getEventId(e))},_handleLoad:function(e){this.removeLoader(this.getEventId(e))},getEventId:function(e){return e.id?e.id:e.layer?e.layer._leaflet_id:e.target._leaflet_id},_layerAdd:function(e){if(e.layer&&e.layer.on)try{e.layer.on({loading:this._handleLoading,load:this._handleLoad},this)}catch(t){console.warn("L.Control.Loading: Tried and failed to add  event handlers to layer",e.layer),console.warn("L.Control.Loading: Full details",t)}},_addLayerListeners:function(e){e.eachLayer(function(e){e.on&&e.on({loading:this._handleLoading,load:this._handleLoad},this)},this),e.on("layeradd",this._layerAdd,this)},_removeLayerListeners:function(e){e.eachLayer(function(e){e.off&&e.off({loading:this._handleLoading,load:this._handleLoad},this)},this),e.off("layeradd",this._layerAdd,this)},_addMapListeners:function(e){e.on({dataloading:this._handleLoading,dataload:this._handleLoad,layerremove:this._handleLoad},this)},_removeMapListeners:function(e){e.off({dataloading:this._handleLoading,dataload:this._handleLoad,layerremove:this._handleLoad},this)}});if(window.L){var n=window.L;n.Control.Loading=o,n.Control.loading=function(e){return new n.Control.Loading(e)}}L.Map.addInitHook(function(){this.options.loadingControl&&(this.loadingControl=new o,this.addControl(this.loadingControl))});var s=L.Control.extend({options:{position:"topleft"},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-control-zoom leaflet-bar leaflet-control");return this._createButton("&#8674;","Measure","leaflet-control-measure leaflet-bar-part leaflet-bar-part-top-and-bottom",t,this._toggleMeasure,this),t},_createButton:function(e,t,i,r,a,o){var n=L.DomUtil.create("a",i,r);return n.innerHTML=e,n.href="#",n.title=t,L.DomEvent.on(n,"click",L.DomEvent.stopPropagation).on(n,"click",L.DomEvent.preventDefault).on(n,"click",a,o).on(n,"dblclick",L.DomEvent.stopPropagation),n},_toggleMeasure:function(){this._measuring=!this._measuring,this._measuring?(L.DomUtil.addClass(this._container,"leaflet-control-measure-on"),this._startMeasuring()):(L.DomUtil.removeClass(this._container,"leaflet-control-measure-on"),this._stopMeasuring())},_startMeasuring:function(){this._oldCursor=this._map._container.style.cursor,this._map._container.style.cursor="crosshair",this._doubleClickZoom=this._map.doubleClickZoom.enabled(),this._map.doubleClickZoom.disable(),L.DomEvent.on(this._map,"mousemove",this._mouseMove,this).on(this._map,"click",this._mouseClick,this).on(this._map,"dblclick",this._finishPath,this),this._layerPaint||(this._layerPaint=L.layerGroup().addTo(this._map)),this._points||(this._points=[])},_stopMeasuring:function(){this._map._container.style.cursor=this._oldCursor,L.DomEvent.off(this._map,"mousemove",this._mouseMove,this).off(this._map,"click",this._mouseClick,this).off(this._map,"dblclick",this._mouseClick,this),this._doubleClickZoom&&this._map.doubleClickZoom.enable(),this._layerPaint&&this._layerPaint.clearLayers(),this._restartPath()},_mouseMove:function(e){if(e.latlng&&this._lastPoint){if(this._layerPaintPathTemp)this._layerPaintPathTemp.spliceLatLngs(0,2,this._lastPoint,e.latlng);else{this._layerPaintPathTemp=L.polyline([this._lastPoint,e.latlng],{color:"black",weight:1.5,clickable:!1,dashArray:"6,3"}).addTo(this._layerPaint)}if(this._tooltip){this._distance||(this._distance=0),this._updateTooltipPosition(e.latlng);var t=e.latlng.distanceTo(this._lastPoint);this._updateTooltipDistance(this._distance+t,t)}}},_mouseClick:function(e){if(e.latlng){if(this._lastPoint&&this._tooltip){this._distance||(this._distance=0),this._updateTooltipPosition(e.latlng);var t=e.latlng.distanceTo(this._lastPoint);this._updateTooltipDistance(this._distance+t,t),this._distance+=t}if(this._createTooltip(e.latlng),this._lastPoint&&!this._layerPaintPath){this._layerPaintPath=L.polyline([this._lastPoint],{color:"black",weight:2,clickable:!1}).addTo(this._layerPaint)}this._layerPaintPath&&this._layerPaintPath.addLatLng(e.latlng),this._lastCircle&&this._layerPaint.removeLayer(this._lastCircle);var i={color:"black",opacity:1,weight:1,fill:!0,fillOpacity:1,radius:2,clickable:!!this._lastCircle};this._lastCircle=new L.CircleMarker(e.latlng,i).addTo(this._layerPaint),this._lastCircle.on("click",function(){this._finishPath()},this),this._lastPoint=e.latlng}},_finishPath:function(){this._lastCircle&&this._layerPaint.removeLayer(this._lastCircle),this._tooltip&&this._layerPaint.removeLayer(this._tooltip),this._layerPaint&&this._layerPaintPathTemp&&this._layerPaint.removeLayer(this._layerPaintPathTemp),this._restartPath()},_restartPath:function(){this._distance=0,this._tooltip=undefined,this._lastCircle=undefined,this._lastPoint=undefined,this._layerPaintPath=undefined,this._layerPaintPathTemp=undefined},_createTooltip:function(e){var t=L.divIcon({className:"leaflet-measure-tooltip",iconAnchor:[-5,-5]});this._tooltip=L.marker(e,{icon:t,clickable:!1}).addTo(this._layerPaint)},_updateTooltipPosition:function(e){this._tooltip.setLatLng(e)},_updateTooltipDistance:function(e,t){var i=this._round(e),r=this._round(t),a='<div class="leaflet-measure-tooltip-total">'+i+" nm</div>";0<r&&i!=r&&(a+='<div class="leaflet-measure-tooltip-difference">(+'+r+" nm)</div>"),this._tooltip._icon.innerHTML=a},_round:function(e){return Math.round(e/1852*10)/10},_onKeyDown:function(e){27==e.keyCode&&(this._lastPoint?this._finishPath():this._toggleMeasure())}});if(window.L){var l=window.L;l.Control.Measure=s,l.control.measure=function(e){return new l.Control.Measure(e)}}L.Map.mergeOptions({measureControl:!1}),L.Map.addInitHook(function(){this.options.measureControl&&(this.measureControl=new s,this.addControl(this.measureControl))});var c=L.Control.extend({options:{position:"bottomleft",separator:" : ",emptyString:"Unavailable",lngFirst:!1,numDigits:6,lngFormatter:undefined,latFormatter:undefined,prefix:""},onAdd:function(e){return this._container=L.DomUtil.create("div","leaflet-control-mouseposition"),L.DomEvent.disableClickPropagation(this._container),e.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(e){e.off("mousemove",this._onMouseMove)},_onMouseMove:function(e){var t=this.options.lngFormatter?this.options.lngFormatter(e.latlng.lng):L.Util.formatNum(e.latlng.lng,this.options.numDigits),i=this.options.latFormatter?this.options.latFormatter(e.latlng.lat):L.Util.formatNum(e.latlng.lat,this.options.numDigits),r=this.options.lngFirst?t+this.options.separator+i:i+this.options.separator+t,a=this.options.prefix+" "+r;this._container.innerHTML=a}});L.Control.MousePosition=c,L.control.mousePosition=function(e){return new L.Control.MousePosition(e)},L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new c,this.addControl(this.positionControl))});var h=function(e,t){return(h=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function f(e,t){function i(){this.constructor=e}h(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}var d=(y.prototype.disable=function(){this.doneEditing(!1),this.unregisterTool()},y.prototype.unregisterTool=function(){if(this.tool){this.tool.deactivate();var e=this.map.getMap();e.removeControl(this.tool),e.removeLayer(this.editingLayer)}},y.prototype.showOriginalLayer=function(e){if(this.feature){var t=this.feature.properties.id,i=this.map.getFeatureLayer(t);this.map.setFeatureVisibility(i,e)}},y.prototype.beginEditing=function(){if(this.visible){this.originalFeature=L.GeoJSON.geometryToLayer(this.feature.toGeoJSON()),this.feature.properties._editing=!0;var e=this.map.getMap(),t=this.map.getFeatureLayer(this.feature.properties.id);if(t){var i=this.editingLayer=(new L.FeatureGroup).addTo(e);if(0===this.feature.geometry.type.indexOf("Multi")){var r=this.feature.geometry.type.replace("Multi","");this.feature.geometry.coordinates.each(function(e){var t={type:r,coordinates:e};new L.GeoJSON(t,{onEachFeature:function(e,t){i.addLayer(t)}})})}else"GeometryCollection"===this.feature.geometry.type?this.feature.geometry.geometries.each(function(e){new L.GeoJSON(e,{onEachFeature:function(e,t){i.addLayer(t)}})}):new L.GeoJSON(t.toGeoJSON()).eachLayer(function(e){i.addLayer(e)});this.showOriginalLayer(!1),this.tool=new g({featureGroup:i}).addTo(e),this.tool.activate()}}},y.prototype.doneEditing=function(e){if(this.feature.properties._editing=!1,void 0===e||e)if(this.tool&&this.tool.hasBeenEdited()){var i=~this.feature.geometry.type.indexOf("Multi"),r="GeometryCollection"===this.feature.geometry.type,a=[],o=[],n=void 0;this.editingLayer.eachLayer(function(e){var t=e.toGeoJSON();n=t.geometry,i?o[o.length]=n.coordinates:r&&(a[a.length]=t)}),i?this.feature.geometry.coordinates=o:r?this.feature.geometry.geometries=a:this.feature.geometry=n,this.map.replaceFeature(this.feature)}else this.showOriginalLayer(!0),this.map.updateFeature(this.feature);else this.showOriginalLayer(this.visible),this.map.updateFeature(this.feature);this.tool&&this.unregisterTool()},y.prototype.addProperty=function(){},y.prototype.highlightFeature=function(){this.map.focusFeature(this.feature.properties.id)},y.prototype.deleteFeature=function(){this.map.removeFeature(this.feature.properties.id)},y.prototype.updateFeature=function(){if(this.editingLayer){var t=this.feature.properties.style;this.editingLayer.eachLayer(function(e){"Point"!==e.feature.geometry.type&&e.setStyle(t)})}else this.map.updateFeature(this.feature)},y.prototype.cancelEditing=function(){this.feature=this.originalFeature,this.doneEditing(!1)},y);function y(e,t,i){this.map=e,this.feature=t,this.visible=!1}var m,g=(f(v,m=L.Control),v.prototype.onAdd=function(e){this.map=e;var t={selectedPathOptions:{dashArray:"10, 10",fill:!(this.enabled=!1),fillColor:"#fe57a1",fillOpacity:.1,maintainColor:!1}};return t.featureGroup=this.options.featureGroup,this.handler=new i.Draw.EditToolbar.Edit(e,t),L.DomUtil.create("div","leaflet-edit-feature")},v.prototype.onRemove=function(e){this.deactivate()},v.prototype.activate=function(){this.enabled=!0,this.handler.enable()},v.prototype.deactivate=function(){this.enabled=!1,this.handler.disable()},v.prototype.hasBeenEdited=function(){var t=!1;return this.options.featureGroup&&this.options.featureGroup.eachLayer(function(e){t=t||e.edited}),t},v);function v(e){return m.call(this,Object.assign({position:"bottomright",draw:!1,edit:!1},e||{}))||this}function _(e,t){var i=e.exec(t);return i&&i.length?i[1]:null}var b="http://www.geoplatform.gov/ont/openlayer/MapBoxVectorTileLayer",S="http://www.geoplatform.gov/ont/openlayer/OSMLayer",w={test:function(e){return e&&e.resourceTypes&&e.resourceTypes.length&&~e.resourceTypes.indexOf(S)},get:function(e){var t=p.QueryFactory().fields("*").resourceTypes(S);return e||(e=new p.LayerService(p.Config.ualUrl,new p.XHRHttpClient)),e.search(t).then(function(e){return e.results.length?e.results[0]:null})}},C={get:function(e){e||(e=new p.LayerService(p.Config.ualUrl,new p.XHRHttpClient));var t=p.Config.defaultBaseLayerId||"86a8babde086689e21248669ba4ed579";return e.get(t)["catch"](function(){return w.get()})},set:function(e){var t=null;e&&e.id?t=e.id:e&&"string"==typeof e&&(t=e),t&&p.Config.configure({defaultBaseLayerId:e.id})}},E=/OGC.+\(([A-Z\-]+)\)/,M=/Esri REST ([A-Za-z]+) Service/,x={ESRI_FEATURE_SERVER:{id:"48980c5bad0c8d4666b393874eb5279a",uri:"http://www.geoplatform.gov/spec/esri-feature-rest",type:"dct:Standard",description:"Esri ArcGIS Feature Server REST API",label:"Esri REST Feature Service"},ESRI_IMAGE_SERVER:{id:"bcdf764e52064c84323f3f1baea7e245",uri:"http://www.geoplatform.gov/spec/esri-image-rest",type:"dct:Standard",description:"Esri ArcGIS Image Server REST API",label:"Esri REST Image Service"},ESRI_MAP_SERVER:{id:"370cf6ca5d91c07b63329b8384fe76c7",uri:"http://www.geoplatform.gov/spec/esri-map-rest",type:"dct:Standard",description:"Esri ArcGIS Map Server REST API",label:"Esri REST Map Service"},ESRI_TILE_SERVER:{id:"c75570ff2523b1a1631afe7ddac27beb",uri:"http://www.geoplatform.gov/spec/esri-tile-rest",type:"dct:Standard",description:"Esri ArcGIS Tile Server REST API",label:"Esri REST Tile Service"},KML:{id:"c0b39ca2049ba2184472ff27408ffd7e",uri:"http://opengis.net/spec/kml",type:"dct:Standard",description:"OGC Keyhole Markup Language (KML)",label:"OGC Keyhole Markup Language (KML)"},CSW:{id:"60de6a422475493b7901ae453d6f4562",uri:"http://opengis.net/spec/csw",type:"dct:Standard",description:"OGC Web Catalog Service (CSW)",label:"OGC Web Catalog Service (CSW)"},WCS:{id:"a7e5a2d81a83d4eae9bf9138f24d0a32",uri:"http://opengis.net/spec/wcs",type:"dct:Standard",description:"OGC Web Coverage Service (WCS)",label:"OGC Web Coverage Service (WCS)"},WFS:{id:"e70e43ed52f83634285a09e959734bff",uri:"http://opengis.net/spec/wfs",type:"dct:Standard",description:"OGC Web Feature Service (WFS)",label:"OGC Web Feature Service (WFS)"},WMS:{id:"abed5a00c536fb2d7019092c37ed634c",uri:"http://opengis.net/spec/wms",type:"dct:Standard",description:"OGC Web Map Service (WMS)",label:"OGC Web Map Service (WMS)"},WMTS:{id:"757858ae77cf8c602b39294c27632dd7",uri:"http://opengis.net/spec/wmts",type:"dct:Standard",description:"OGC Web Map Tile Service (WMTS)",label:"OGC Web Map Tile Service (WMTS)"},WMST:{id:"faae5bff49b1144d500380cbc055c1e5",uri:"http://www.geoplatform.gov/spec/ogc-wms-t",type:"dct:Standard",description:"OGC WMS support for temporal according to OGC Best Practice guidance",label:"OGC WMS-T Service"},FEED:{id:"8edc61870e534a1f23dc967753da3b72",uri:"http://www.geoplatform.gov/spec/feed",type:"dct:Standard",description:"GeoPlatform GeoJSON Feed Service converts an Atom/RSS feed (including GeoRSS and CAP extensions) to GeoJSON",label:"GeoPlatform GeoJSON Feed Service"},refresh:function me(e){var t=p.Config.ualUrl;if(t){var i=p.QueryFactory().types("dct:Standard").resourceTypes("ServiceType").pageSize(50);(e&&"undefined"!=typeof e.search?e:new p.ItemService(t,new p.XHRHttpClient)).search(i).then(function(e){for(var t=0;t<e.results.length;++t){var i=e.results[t],r=null,a=i.label;~a.indexOf("WMS-T")?(r="WMST",i.supported=!0):~a.indexOf("OGC")?(r=_(E,a),i.supported="WMS"===r||"WMTS"===r):~a.indexOf("Esri")?(r=_(M,a),i.supported=!0,r="ESRI_"+r.toUpperCase()+"_SERVER"):~a.indexOf("Feed")?(r="FEED",i.supported=!0):r=a,x[r]=i}})["catch"](function(e){console.log("Error loading supported service types: "+e.message)})}else console.log("WARN : ServiceTypes - no GeoPlatform API URL configured, unable to load service types")}};var P=u.FeatureManager.extend({statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose",CLUSTEREVENTS:"clusterclick clusterdblclick clustermouseover clustermouseout clustermousemove clustercontextmenu"},initialize:function(e){u.FeatureManager.prototype.initialize.call(this,e),e=L.Util.setOptions(this,e),this._layers={},this._leafletIds={},this.cluster=new L.MarkerClusterGroup(e),this._key="c"+(1e9*Math.random()).toString(36).replace(".","_"),this.cluster.addEventParent(this)},onAdd:function(e){u.FeatureManager.prototype.onAdd.call(this,e),this._map.addLayer(this.cluster)},onRemove:function(e){u.FeatureManager.prototype.onRemove.call(this,e),this._map.removeLayer(this.cluster)},createLayers:function(e){for(var t=[],i=e.length-1;0<=i;i--){var r=e[i];if(!this._layers[r.id]){var a=L.GeoJSON.geometryToLayer(r,this.options);a.feature=L.GeoJSON.asFeature(r),a.defaultOptions=a.options,a._leaflet_id=this._key+"_"+r.id,this.resetStyle(a.feature.id),this._layers[a.feature.id]=a,this._leafletIds[a._leaflet_id]=r.id,this.options.onEachFeature&&this.options.onEachFeature(a.feature,a),this.fire("createfeature",{feature:a.feature}),(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(r))&&t.push(a)}}t.length&&this.cluster.addLayers(t)},addLayers:function(e){for(var t=[],i=e.length-1;0<=i;i--){var r=this._layers[e[i]];this.fire("addfeature",{feature:r.feature}),t.push(r)}this.cluster.addLayers(t)},removeLayers:function(e,t){for(var i=[],r=e.length-1;0<=r;r--){var a=e[r],o=this._layers[a];this.fire("removefeature",{feature:o.feature,permanent:t}),i.push(o),this._layers[a]&&t&&delete this._layers[a]}this.cluster.removeLayers(i)},resetStyle:function(e){var t=this._layers[e];return t&&(t.options=t.defaultOptions,this.setFeatureStyle(t.feature.id,this.options.style)),this},setStyle:function(t){return this.eachFeature(function(e){this.setFeatureStyle(e.feature.id,t)},this),this},setFeatureStyle:function(e,t){var i=this._layers[e];"function"==typeof t&&(t=t(i.feature)),i.setStyle&&i.setStyle(t)},eachFeature:function(e,t){for(var i in this._layers)e.call(t,this._layers[i]);return this},getFeature:function(e){return this._layers[e]}}),T=a;function I(a){return new Promise(function(t,r){T||r(new Error("Unable to load feature layer style, jQuery is not installed")),T.ajax({url:p.Config.ualUrl+"/api/layers/"+a+"/style",dataType:"json",success:function(e){t(e)},error:function(e,t,i){r(new Error("FeatureStyleResolver() -\n                   Error loading style information for layer "+a+" : "+i))}})})}function F(e){function t(e,i){return e&&e.find?e.find(function(e){var t=e.toLowerCase();return 0<=i.indexOf(t)}):null}var i,r=Object.keys(e.properties),a=t(r,["title","name","label"]),o=a?e.properties[a]:"Untitled",n=t(r,["description","summary","descript"]),s='<div class="feature-popup"><h5>'+o+"</h5><p>"+(n?e.properties[n]:"No description provided")+"</p>";e.properties.modified&&(s+='<div><span class="label">Updated</span><span class="value">'+new Date(e.properties.modified).toDateString()+"</span></div>");e.properties["cap:effective"]&&(s+='<div><span class="label">Effective</span><span class="value">'+(i=new Date(e.properties["cap:effective"])).toDateString()+" "+i.toTimeString()+"</span></div>");e.properties["cap:expires"]&&(s+='<div><span class="label">Expires</span><span class="value">'+(i=new Date(e.properties["cap:expires"])).toDateString()+" "+i.toTimeString()+"</span></div>");var l=t(r,["landingpage","link","website"]);for(var c in l&&(s+="<br>",s+='<a href="'+e.properties[l]+'" target="_blank">link</a>'),s+="<hr>",e.properties)if(a!==c&&n!==c&&l!==c&&"modified"!==c){var u=e.properties[c];if("object"==typeof u)for(var p in u)s+='<div><span class="label">'+c+"."+p+'</span><span class="value">'+u[p]+"</span></div>";else s+='<div><span class="label">'+c+'</span><span class="value">'+u+"</span></div>"}return s+="</div>"}var O=a,R=P.extend({currentVisibility:!0,currentOpacity:1,_gpStyle:{color:"#00f",weight:2,fillColor:"#00f",fillOpacity:.3},pointToLayerFn:function(e,t){var i=e&&e.properties?e.properties.style:null;if(!i&&"function"==typeof this.options.style)try{i=this.options.style(e)}catch(l){console.log("error using style function in ClusteredFeatureLayer: "+l.message)}(i=i||this.options.style||{}).radius=i["stroke-width"]||i.radius||4,i.weight=i["stroke-width"]||i.weight||2,i.color=i.stroke||i.color||"#03f",i.opacity=i["stroke-opacity"]||i.opacity||.9,i.fillOpacity=i["fill-opacity"]||i.opacity||.3,i.fillColor=i.fill||i.color||"#03f",i.renderer=this.options.renderer;var r=null;if("image"===i.shape){var a=i.width||16,o=i.height||16,n={icon:L.icon({iconUrl:i.content,iconSize:[a,o],iconAnchor:[.5*a,.5*o],popupAnchor:[0,-11]})};p.Config.leafletPane&&(n.pane=p.Config.leafletPane),r=L.marker(t,n)}else r=L.circleMarker(t,i);var s=this.options.popupTemplate||F;return r.bindPopup(s(e)),r},eachFeatureFn:function(e,t){e&&e.geometry&&"Point"!==e.geometry.type&&t.bindPopup(F(e))},initialize:function(e){var t=this;e=e||{},p.Config.leafletPane&&(e.pane=p.Config.leafletPane),e.pointToLayer=L.Util.bind(this.pointToLayerFn,this),e.onEachFeature=L.Util.bind(this.eachFeatureFn,this),e.spiderfyDistanceMultiplier=2;e.style=e.style||function(){return t._gpStyle},e.styleResolver&&(this.styleResolver=e.styleResolver);var i={};p.Config.leafletPane&&(i.pane=p.Config.leafletPane);var r=L.SVG&&L.svg(i)||L.Canvas&&L.canvas();e.renderer=r,P.prototype.initialize.call(this,e),this.on("load",function(){"undefined"!=typeof this.options.zIndex&&this.setZIndex(this.options.zIndex)})},onAdd:function(e){P.prototype.onAdd.call(this,e),this.options.layerId&&this.loadStyle(this.options.layerId)},createLayers:function(e){P.prototype.createLayers.call(this,e),this.setVisibility(this.currentVisibility),this.setOpacity(this.currentOpacity)},setZIndex:function(e){for(var t in this.options.zIndex=e,this._layers){var i=this._layers[t];i.setZIndex?i.setZIndex(e):i._updateZIndex?i._updateZIndex(e):i._renderer&&i._renderer._container&&(i._renderer._container.style.zIndex=e)}},toggleVisibility:function(){this.currentVisibility=!this.currentVisibility,this.setVisibility(this.currentVisibility)},setVisibility:function(e){if(this.currentVisibility=!!e,this.options.renderer._container&&(this.options.renderer._container.style.display=e?"":"none"),this.cluster&&this.cluster._featureGroup&&this.cluster._featureGroup._layers)for(var t in this.cluster._featureGroup._layers){if((r=this.cluster._featureGroup._layers[t])._icon){var i=O(r._icon);e?i.removeClass("invisible"):i.addClass("invisible")}}if(this._layers)for(var t in this._layers){var r;(r=this._layers[t]).setVisibility?r.setVisibility(e):r.setStyle&&r.setStyle({display:e?"":"none"})}},setOpacity:function(e){if(this.currentOpacity=isNaN(e)?1:1*e,this.cluster&&this.cluster._featureGroup&&this.cluster._featureGroup._layers)for(var t in this.cluster._featureGroup._layers){(i=this.cluster._featureGroup._layers[t])._icon&&O(i._icon).css({opacity:e})}if(this._layers)for(var t in this._layers){var i;(i=this._layers[t]).setOpacity&&i.setOpacity(e)}},setStyle:function(t){this.eachFeature(function(e){this.setFeatureStyle(e.feature.id,t)},this)},loadStyle:function(e){var o=this;this.options.styleLoader&&this.options.styleLoader(e).then(function(e){if(e){var t=null;if(e&&e.styles){var i=function(){return function(e){var t=this.property||this.field1,i=e[t]||(e.properties?e.properties[t]:null),r=null;if(this.styles){var a=this.styles.find(function(e){return e.value===i});a?((r=a.style).radius=r["stroke-width"]||r.radius||4,r.weight=r["stroke-width"]||r.weight||2,r.color=r.stroke||r.color||"#03f",r.opacity=r["stroke-opacity"]||r.opacity||.9,r.fillOpacity=r["fill-opacity"]||r.opacity||.3,r.fillColor=r.fill||r.color||"#03f"):console.log("No matching style for "+JSON.stringify(e.properties))}return r}(e)};return o.options.style=i,void setTimeout(function(e,t){e.setStyle(t)},1e3,o,i)}if(e&&"undefined"!=typeof e.push)t=e[0];else{if(!e)return;t=e}if(t.shape){var r=O.extend({},t);for(var a in r.style=t,o._gpStyle=t,o._layers)o._layers[a].setStyle(r)}}})["catch"](function(e){console.log("Error fetching feature layer style"),console.log(e)})}});function G(e,t){var i=e.services&&e.services.length?e.services[0]:null;if(!i){throw new Error("clusteredFeatures() -\n                  Cannot create leaflet layer for GP Layer:\n                  layer has no service")}var r=i.href,a=(e.supportedFormats&&e.supportedFormats[0],t&&t.styleResolver?t.styleResolver:I),o={url:r+"/"+e.layerName,styleLoader:a,layerId:e.id};return p.Config.leafletPane&&(o.pane=p.Config.leafletPane),t&&t.leafletPane&&(o.pane=t.leafletPane),new R(o)}function k(e,t){var i=e.services&&e.services.length?e.services[0]:null;if(!i){throw new Error("geoJsonFeed() -\n                  Cannot create leaflet layer for GP Layer:\n                  layer has no service")}var o,r=i.href,a=(e.supportedFormats&&e.supportedFormats[0],r+("/"===r[r.length-1]?"":"/")+e.id+"/FeatureServer/"+e.layerName),n=r.replace("feeds","styles")+("/"===r[r.length-1]?"":"/")+e.id,s={url:a,isModern:!0,layerId:e.id,styleLoader:(o=n,function(a){return new Promise(function(t,r){O||r(new Error("Unable to load GeoJSON feed style, jQuery is not installed")),O.ajax(o,{dataType:"json",success:function(e){t(e)},error:function(e,t,i){r(new Error("geoJsonFeed() -\n                            Error loading style information for layer "+a+" : "+i))}})})})};return p.Config.leafletPane&&(s.pane=p.Config.leafletPane),t&&t.leafletPane&&(s.pane=t.leafletPane),new R(s)}var D,W=a,N=(f(A,D=L.TileLayer.WMS),A.prototype.enableGetFeatureInfo=function(){this._map.on("click",this.getFeatureInfo,this),this._enabled=!0},A.prototype.disableGetFeatureInfo=function(){this._map.off("click",this.getFeatureInfo,this),this._enabled=!1},A.prototype.isGetFeatureInfoEnabled=function(){return this._enabled},A.prototype.onRemove=function(e){return this.isGetFeatureInfoEnabled()&&this.disableGetFeatureInfo(),D.prototype.onRemove.call(this,e)},A.prototype.getFeatureInfo=function(e){var t=this.getFeatureInfoUrl(e.latlng),r=this.parseGetFeatureInfo;W.ajax({url:t,success:function(e,t,i){"string"!=typeof e&&(e=r(e))},error:function(e,t,i){}})},A.prototype.getFeatureInfoUrl=function(e){var t=this._map.latLngToContainerPoint(e),i=this._map.getSize(),r={srs:"EPSG:4326",bbox:this._map.getBounds().toBBoxString(),height:i.y,width:i.x,info_format:"text/xml",x:t.x,y:t.y,i:t.x,j:t.y},a="/api/layers/"+this.wmsParams.wmvId+"/feature";return p.Config.ualUrl+a+L.Util.getParamString(r,a,!0)},A.prototype.parseGetFeatureInfo=function(e){var t=[];for(var i in e)t.push(["<div><strong>",i,": </strong>",e[i],"</div>"].join(" "));return 0==t.length&&t.push("<em>No data available</em>"),"<div>"+t.join(" ")+"</div>"},A.prototype.showGetFeatureInfo=function(e,t,i){e?console.log(e):L.popup({maxWidth:800}).setLatLng(t).setContent(i).openOn(this._map)},A);function A(e,t){var i=D.call(this,e,t)||this;return i._enabled=!1,i._enabled=!1,i}function U(e){var t=e.services&&e.services.length?e.services[0]:null;if(!t)throw new Error("Cannot create leaflet layer for WMS Layer '"+(e.label||e.id)+"' because layer has no service associated with it");var i=t.href;if(!i)throw new Error("WMS layer's service does not defined a service url");var r=function l(e){var t=e.formats;if(t&&t.length)for(var i=["image/png32","image/png24","image/png8","image/png","image/jpeg"];0<i.length;)if(0<=t.indexOf(i[0]))return i[0];return console.log("Layer '"+e.label+"' has no formats specified, assuming a default of 'image/png'"),"image/png"}(e),a=e.crs||[];a&&0<a.length&&~a.indexOf("ESPG:3857")&&console.log("Layer '"+e.label+"' does not support EPSG:3857 Spherical Mercator projection and may not render appropriately or at all.");var o="1.1.1",n=t.serviceTypeVersions||[];n.length&&n.indexOf("1.1.1")<0?o=n[0]:console.log("Warning: WMS Service doesn't list supported versions, assuming 1.1.1");var s={layers:e.layerName,transparent:!0,format:r,wmvId:e.id,version:o};return p.Config.leafletPane&&(s.pane=p.Config.leafletPane),new N(i,s)}if(window.L){var V=window.L;V.TileLayer.WMS=N,V.tileLayer.wms=U}var z,j=(f(B,z=L.TimeDimension.Layer.WMS),B.prototype._parseTimeDimensionFromCapabilities=function(e){var t=e.querySelectorAll("Layer"),i=this._baseLayer.wmsParams.layers,r=null,a=null;return t.forEach(function(e){e.querySelector("Name").innerHTML===i&&(r=e)}),r&&((a=this._getTimesFromLayerCapabilities(r))||(a=this._getTimesFromLayerCapabilities(r.parentNode))),a},B.prototype._getTimesFromLayerCapabilities=function(e){var t=null,i=e.querySelectorAll("Dimension[name='time']");if(i&&i.length&&i[0].textContent.length&&(t=i[0].textContent.trim()),!t||!t.length){var r=e.querySelectorAll("Extent[name='time']");r&&r.length&&r[0].textContent.length&&(t=r[0].textContent.trim())}return t&&~t.indexOf("current")&&(t=t.replace("current",(new Date).toISOString())),t},B);function B(e,t){return z.call(this,e,t)||this}function J(e){var t=e.services[0],i=t.href;if(!i)throw new Error("WMST Layer's service does not defined a service url");var r={layers:e.layerName,transparent:!0,format:"image/png",wmvId:e.layerId};p.Config.leafletPane&&(r.pane=p.Config.leafletPane);var a=new N(i,r),o=p.Config.ualUrl+"/api/services/"+t.id+"/proxy/capabilities",n={times:null};if(e.temporal){var s=e.temporal.startDate?new Date(e.temporal.startDate):new Date,l=e.temporal.endDate?new Date(e.temporal.endDate):new Date;n.times=s.toISOString()+"/"+l.toISOString()+"/P1D"}return new j(a,{timeDimension:new L.TimeDimension(n),proxy:o})}if(window.L){var Z=window.L;Z.TileLayer.WMST=j,Z.tileLayer.wmst=J}var H=/\{ *([\w_-]+) *\}/g;var q,K=(f(X,q=L.TileLayer),X.prototype.initialize=function(e,t){this._url=e,this.defaultWmtsParams={service:"WMTS",request:"GetTile",version:"1.0.0",layers:"",styles:"",tileMatrixSet:"",format:"image/png"};var i=L.Util.extend({},this.defaultWmtsParams),r=t.tileSize||this.options.tileSize;for(var a in t.detectRetina&&L.Browser.retina?i.width=i.height=2*r:i.width=i.height=r,t)this.options.hasOwnProperty(a)||"matrixIds"==a||(i[a]=t[a]);this.wmtsParams=i,this.matrixIds=t.matrixIds||this.getDefaultMatrix(),L.Util.setOptions(this,t)},X.prototype.onAdd=function(e){return this._crs=this.options.crs||e.options.crs,q.prototype.onAdd.call(this,e)},X.prototype.getTileUrl=function(e){var t=this.options.tileSize,i=e.multiplyBy(t);i.x+=1,i.y-=1;var r=i.add(new L.Point(t,t)),a=this._tileZoom,o=this._crs.project(this._map.unproject(i,a)),n=this._crs.project(this._map.unproject(r,a)).x-o.x,s=this.matrixIds[a].identifier,l=(this.wmtsParams.tileMatrixSet,this.matrixIds[a].topLeftCorner.lng),c=this.matrixIds[a].topLeftCorner.lat,u=Math.floor((o.x-l)/n),p=-Math.floor((o.y-c)/n),h=this._url,f=h.indexOf("{TileMatrix}"),d=h.indexOf("{TileRow}"),y=h.indexOf("{TileCol}"),m=Object.assign({s:this._getSubdomain(e)},this.wmtsParams);for(var g in 0<f&&(m.TileMatrix=s),0<d&&(m.TileRow=p),0<y&&(m.TileCol=u),m)m[g.toLowerCase()]=m[g];var v=(h=function _(e,r){return e.replace(H,function(e,t){var i=r[t];if(i===undefined&&(i=r[t.toLowerCase()]),i===undefined)throw new Error("No value provided for variable "+e);return"function"==typeof i&&(i=i(r)),i})}(h,m)).indexOf("?");return v<0||f<v&&d<v||y<v||(h+=L.Util.getParamString(this.wmtsParams,h),f<0&&(h+="&TileMatrix="+s),d<0&&(h+="&TileRow="+p),y<0&&(h+="&TileCol="+u)),h},X.prototype.setParams=function(e,t){return L.Util.extend(this.wmtsParams,e),t||this.redraw(),this},X.prototype.getDefaultMatrix=function(){for(var e=new Array(22),t=0;t<22;t++)e[t]={identifier:""+t,topLeftCorner:new L.LatLng(20037508.3428,-20037508.3428)};return e},X.prototype._getSubdomain=function(e){var t=Math.abs(e.x+e.y)%this.options.subdomains.length;return this.options.subdomains[t]},X);function X(e,t){return q.call(this,e,t)||this}function Q(e){var r=e.services&&e.services.length?e.services[0].href:null,t=e.crs||[];t&&0<t.length&&~t.indexOf("ESPG:3857")&&console.log("Layer '"+e.label+"' does not support EPSG:3857 Spherical Mercator projection and may not render appropriately or at all.");var i={layer:e.layerName,style:"default",tileMatrixSet:"default",format:"image/png"};p.Config.leafletPane&&(i.pane=p.Config.leafletPane);var a=(e.distributions||[]).find(function(e){return e&&e.href&&("image/png"===e.mediaType||"image/jpeg"===e.mediaType)});if(!a)throw new Error("WTMS Layer - layer "+e.id+" has no distribution(s) usable to make WMTS requests");if(r=a.href,i.format=a.mediaType,(a.parameters||[]).forEach(function(e){var t=e.name.toLowerCase();if("tilematrix"!==t&&"tilerow"!==t&&"tilecol"!==t){var i=e.defaultValue||e.values&&e.values.length&&e.values[0];null!==i&&i!==undefined&&(r=r.replace("{"+e.name+"}",i))}}),!r)throw new Error("Unable to determine WMTS URL for layer "+e.id+". Please make sure it is defined by either the service or a distribution on the layer itself.");return new K(r,i)}if(window.L){var Y=window.L;Y.TileLayer.WMTS=K,Y.tileLayer.wmts=Q}var $,ee=(f(te,$=L.TileLayer),te.prototype.initialize=function(e,t){if(!e)throw new Error("Layer was not configured with a URL");if(this.defaultESRIParams={layers:"",transparent:!0,format:"png32",f:"image"},e.indexOf("/export")<0){var i=e.indexOf("?");0<i?e=e.substring(0,i)+"/export"+e.substring(i):e+="/export"}this._url=e;var r,a=L.Util.extend({},this.defaultESRIParams),o=t.tileSize||this.options.tileSize;for(var n in r=t.detectRetina&&L.Browser.retina?a.height=2*o:a.height=o,a.size=r+","+r,t)this.options.hasOwnProperty(n)||"crs"===n||(a[n]=t[n]);this.esriParams=a,L.Util.setOptions(this,t)},te.prototype.onAdd=function(e){return this._crs=this.options.crs||e.options.crs,this.esriParams.srs=this.esriParams.imagesr=this.esriParams.bboxsr=this._crs.code,$.prototype.onAdd.call(this,e)},te.prototype.getTileUrl=function(e){var t=this._map,i=this.options.tileSize,r=e.multiplyBy(i),a=r.add([i,i]),o=this._crs.project(t.unproject(r,e.z)),n=this._crs.project(t.unproject(a,e.z)),s=[o.x,n.y,n.x,o.y].join(","),l=L.Util.template(this._url,{s:this._getSubdomain(e)}),c=L.Util.extend({},this.esriParams);return c.layers="show:"+c.layers,"EPSG:3857"===c.bboxsr&&(c.bboxsr="102100"),"EPSG:3857"===c.imagesr&&(c.imagesr="102100"),l+L.Util.getParamString(c,l,!0)+"&BBOX="+s},te.prototype.setParams=function(e,t){return L.Util.extend(this.esriParams,e),t||this.redraw(),this},te.prototype._getSubdomain=function(e){var t=Math.abs(e.x+e.y)%this.options.subdomains.length;return this.options.subdomains[t]},te);function te(e,t){return $.call(this,e,t)||this}if(window.L){var ie=window.L;ie.TileLayer.ESRI=ee,ie.tileLayer.esri=function(e,t){return new ie.TileLayer.ESRI(e,t)}}function re(){return new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:1,maxZoom:19,attribution:'Map data (c) <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'})}function ae(){this.factories=[],this.init()}L.Layer.include({setZIndex:function(e){},setOpacity:function(e){}});var oe=new(ae.prototype.register=function(e){"function"==typeof e&&this.factories.push(e)},ae.prototype.setLayerService=function(e){this.service=e},ae.prototype.getStyleResolver=function(){return this.service&&"undefined"!=typeof this.service.style||(this.service=new p.LayerService(p.Config.ualUrl,new p.XHRHttpClient)),function t(e){if(!e||"function"!=typeof e.style)throw new Error("Must provide a LayerService instance");return function(r){return new Promise(function(t,i){e.style(r).then(function(e){return t(e)})["catch"](function(e){var t="Error loading style information for layer "+r+" : "+e.message;i(new Error(t))})})}}(this.service)},ae.prototype.create=function(e){if(!e)throw new Error("LayerFactory expects a layer object");for(var t=0;t<this.factories.length;++t){var i=this.factories[t],r=i&&"function"==typeof i&&i(e);if(r)return r}return null},ae.prototype.init=function(){var c=this;this.register(function(e){if(e&&e.resourceTypes&&e.resourceTypes.length&&~e.resourceTypes.indexOf(S))return re()}),this.register(function(e){if(!e||!e.services||!e.services.length)return null;var t,i=e.services[0],r=i.href,a=i.serviceType,o=a?a.uri:null,n=e.supportedFormats?e.supportedFormats[0]:null;function s(e){if(!e)throw new Error("Layer's service does not define a service url")}if(x.ESRI_MAP_SERVER&&x.ESRI_MAP_SERVER.uri===o){s(r),t={layers:e.layerName,transparent:!0,format:n||"png32"};var l=e.crs||[];return l&&0<l.length&&~l.indexOf("ESPG:3857")&&console.log("Layer '"+e.label+"' does not support EPSG:3857 Spherical Mercator projection and may not render appropriately or at all."),p.Config.leafletPane&&(t.pane=p.Config.leafletPane),new ee(r,t)}return x.ESRI_FEATURE_SERVER&&x.ESRI_FEATURE_SERVER.uri===o?(s(r),G(e,{styleResolver:c.getStyleResolver()})):x.ESRI_TILE_SERVER&&x.ESRI_TILE_SERVER.uri===o?(s(r),t={url:r,useCors:!0},p.Config.leafletPane&&(t.pane=p.Config.leafletPane),u.tiledMapLayer(t)):x.ESRI_IMAGE_SERVER&&x.ESRI_IMAGE_SERVER.uri===o?(t={url:r,useCors:!0},p.Config.leafletPane&&(t.pane=p.Config.leafletPane),u.imageMapLayer(t)):null}),this.register(function(e){if(!e||!e.services||!e.services.length)return null;var t=e.services[0].serviceType,i=t?t.uri:null;return x.WMS&&x.WMS.uri===i?U(e):x.WMST&&x.WMST.uri===i?J(e):x.WMTS&&x.WMTS.uri===i?Q(e):null}),this.register(function(e){if(!e||!e.services||!e.services.length)return null;var t=e.services[0].serviceType,i=t?t.uri:null;return x.FEED&&x.FEED.uri===i?k(e,{styleResolver:c.getStyleResolver()}):null}),this.register(function(e){if(!e)return null;if((e.resourceTypes||[]).indexOf(b)<0)return null;var t=e.href;if(!t||t.indexOf(".pbf")<0)return console.log("LayerFactory - Layer does not define an Access URL"),null;var i=L;if("undefined"==typeof i.vectorGrid&&"undefined"==typeof i.vectorGrid.protobuf)return console.log("LayerFactory - Leaflet Vector Tiles plugin not found"),null;var r={rendererFactory:L.canvas.tile};return p.Config.leafletPane&&(r.pane=p.Config.leafletPane),i.vectorGrid.protobuf(t,r)})},ae),ne=a,se=u.FeatureLayer.extend({_gpStyle:{color:"#00f",weight:2,fillColor:"#00f",fillOpacity:.3},pointToLayerFn:function(e,t){var i=e&&e.properties?e.properties.style:null;if(!i&&"function"==typeof this.options.style)try{i=this.options.style(e)}catch(l){console.log("error using style function in ClusteredFeatureLayer: "+l.message)}var r=null;if("image"===(i=i||this.options.style||{}).shape){var a=i.width||16,o=i.height||16,n={icon:L.icon({iconUrl:i.content,iconSize:[a,o],iconAnchor:[.5*a,.5*o],popupAnchor:[0,-11]})};p.Config.leafletPane&&(n.pane=p.Config.leafletPane),r=L.marker(t,n)}else i.radius=i.radius||i["stroke-width"]||4,i.weight=i.weight||i["stroke-width"]||2,i.color=i.color||i.stroke||"#03f",i.opacity=i.opacity||i["stroke-opacity"]||.9,i.fillOpacity=i.opacity||i["fill-opacity"]||.3,i.fillColor=i.color||i.fill,i.renderer=this.options.renderer,r=L.circleMarker(t,i);var s=this.options.popupTemplate||F;return r.bindPopup(s(e)),r},eachFeatureFn:function(e,t){e&&e.geometry&&"Point"!==e.geometry.type&&t.bindPopup(F(e))},initialize:function(e){var t=this;e=e||{},p.Config.leafletPane&&(e.pane=p.Config.leafletPane);e.style=e.style||t._gpStyle;var i={};p.Config.leafletPane&&(i.pane=p.Config.leafletPane);var r=L.SVG&&L.svg(i)||L.Canvas&&L.canvas();e.renderer=r,e.pointToLayer=L.Util.bind(this.pointToLayerFn,this),e.onEachFeature=L.Util.bind(this.eachFeatureFn,this),se.prototype.initialize.call(this,e),this.on("load",function(){"undefined"!=typeof this.options.zIndex&&this.setZIndex(this.options.zIndex)})},setZIndex:function(e){for(var t in this.options.zIndex=e,this._layers)this._layers[t].setZIndex(e)},toggleVisibility:function(){for(var e in this._layers){this._layers[e].toggleVisibility&&this._layers[e].toggleVisibility()}},setOpacity:function(e){for(var t in this._layers){var i=this._layers[t];i.setOpacity&&i.setOpacity(e)}},loadStyle:function(e){var o=this;this.options.styleLoader&&this.options.styleLoader(e).then(function(e){if(e){var t=null;if(e&&e.styles){var i=function(){return function(e){var t=this.property||this.field1,i=e[t]||(e.properties?e.properties[t]:null),r=null;if(this.styles){var a=this.styles.find(function(e){return e.value===i});a&&((r=a.style).radius=r.radius||r["stroke-width"]||4,r.weight=r.weight||r["stroke-width"]||2,r.color=r.color||r.stroke||"#03f",r.opacity=r.opacity||r["stroke-opacity"]||.9,r.fillOpacity=r.opacity||r["fill-opacity"]||.3,r.fillColor=r.color||r.fill)}return r}(e)};return o.options.style=i,void o.setStyle(i)}if(e&&"undefined"!=typeof e.push)t=e[0];else{if(!e)return;t=e}if(t.shape){var r=ne.extend({},t);for(var a in r.style=t,o._gpStyle=t,o._layers)o._layers[a].setStyle(r)}}})["catch"](function(e){console.log("Error fetching feature layer style"),console.log(e)})}}),le=a,ce=(ue.prototype.on=function(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)},ue.prototype.off=function(e,t){if(e||(this._listeners={}),this._listeners[e])if(t){var i=this._listeners[e].indexOf(t);0<=i&&this._listeners[e].splice(i,1)}else this._listeners[e]=[]},ue.prototype.notify=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];if(this._listeners[e]){var r=Array.prototype.slice.call(arguments,1);this._listeners[e].forEach(function(e){e.apply(null,r)})}},ue);function ue(){this._listeners={}}var pe,he=(f(fe,pe=ce),fe.prototype.dispose=function(){this.destroyMap(),this.svcCache=null,this.serviceFactory=null,this.httpClient=null,this._key=null,this._mapId=null,this._mapDef=null,this._mapInstance=null,this._defaultExtent=null,this._baseLayerDef=null,this._baseLayer=null,this._layerStates=null,this._layerCache=null,this._layerErrors=null,this._featureLayer=null,this._featureLayerVisible=!0,this._tools=null,this.state=null,this._geoJsonLayerOpts=null},fe.prototype.getKey=function(){return this._key},fe.prototype.setService=function(e){},fe.prototype.setServiceFactory=function(e){this.svcCache={},this.serviceFactory=e},fe.prototype.setHttpClient=function(e){this.svcCache={},this.httpClient=e},fe.prototype.getService=function(e){return this.svcCache[e]||(this.svcCache[e]=this.serviceFactory(e,p.Config.ualUrl,this.httpClient)),this.svcCache[e]},fe.prototype.setErrorHandler=function(e){this._layerErrorHandler=e},fe.prototype.getLayerStateIndex=function(e){if(!e)return-1;for(var t=0;t<this._layerStates.length;++t)if(this._layerStates[t].layer&&e===this._layerStates[t].layer.id)return t;return-1},fe.prototype.getLayerState=function(e){var t=this.getLayerStateIndex(e);return 0<=t?this._layerStates[t]:null},fe.prototype.initializeMapDefinition=function(){return{type:p.ItemTypes.MAP,title:"My New Map",label:"My New Map",description:"This map needs a description",createdBy:null,baseLayer:this._baseLayerDef,layers:[],keywords:[],themes:[],resourceTypes:["http://www.geoplatform.gov/ont/openmap/GeoplatformMap"]}},fe.prototype.getMapResourceContent=function(e){(e=e||{}).layers=this._layerStates.map(function(e){return{visibility:e.visibility||!0,opacity:isNaN(e.opacity)?1:1*e.opacity,layer:{id:e.layer.id,uri:e.layer.uri,label:e.layer.label}}}),e.baseLayer={id:this._baseLayerDef.id,uri:this._baseLayerDef.uri,label:this._baseLayerDef.label},e.annotations=this._featureLayer?{title:"Map Features",geoJSON:this._featureLayer.toGeoJSON()}:null;var t=this._mapInstance.getBounds();return e.extent={minx:t.getWest(),miny:t.getSouth(),maxx:t.getEast(),maxy:t.getNorth()},e},fe.prototype.getDrawControlToolbar=function(){if(!this._mapInstance.drawControl)return null;var e=this._mapInstance.drawControl._toolbars,t=null;for(var i in e)if(e.hasOwnProperty(i)&&e[i]._modes){t=e[i];break}return t},fe.prototype.handleLayerError=function(e){if(this._layerCache){var t=e.target;for(var i in this._layerCache)if(this._layerCache[i]===t){this.processLayerError(e,i);break}}else console.log("Unable to find layer in layer cache. Layer error is "+e)},fe.prototype.processLayerError=function(e,t){function i(e){return e.id===t||e.layer&&e.layer.id===t}var r=this;if(!this._layerErrors.find(i)){var a=this.logLayerError(t,"Layer ('"+t+"') failed to completely load. It may be inaccessible or misconfigured."),o=e.tile.src,n={id:t};o.substring(o.indexOf("?")+1,o.length).split("&").forEach(function(e){var t=e.split("=");n[t[0]]=t[1]});var s=this.getService(p.ItemTypes.LAYER);s&&s.validate(t,n)["catch"](function(e){var t=r._layerStates.find(i);t&&(a.message="Layer '"+t.layer.label+"' failed to completely load. Reported cause: "+e.message),r.notify("layer:error",a)})}},fe.prototype.logLayerError=function(e,t){var i={id:e,message:t};return this._layerErrors.push(i),this._layerErrorHandler&&this._layerErrorHandler(i),i},fe.prototype.touch=function(e){for(var t=[],i=1;i<arguments.length;i++)t[i-1]=arguments[i];this.state.dirty=!0,e&&(1<arguments.length?this.notify.apply(this,Array.prototype.slice.call(arguments)):this.notify(e))},fe.prototype.clean=function(){this.state.dirty=!1},fe.prototype.setMap=function(e){this._mapInstance=e},fe.prototype.getMap=function(){return this._mapInstance},fe.prototype.getMapDefinition=function(){return this._mapDef},fe.prototype.getMapId=function(){return this._mapId},fe.prototype.setView=function(e,t,i){var r=i;void 0===r&&(r=this._mapInstance.getZoom()),this._mapInstance.setView([e,t],r),this.touch("map:view:changed")},fe.prototype.getView=function(){var e=this._mapInstance.getCenter();return[e.lat,e.lng]},fe.prototype.getZoom=function(){return this._mapInstance.getZoom()},fe.prototype.zoomToDefault=function(){if(this._mapInstance){this._defaultExtent?this._mapInstance.fitBounds([[this._defaultExtent.miny,this._defaultExtent.minx],[this._defaultExtent.maxy,this._defaultExtent.maxx]]):(console.log("MapInstance.zoomToDefault() - No default extent specified"),this._mapInstance.setView([38,-96],5));try{this.touch("map:view:changed")}catch(e){}}},fe.prototype.setExtent=function(e){e&&("undefined"!=typeof e.minx&&"undefined"!=typeof e.miny&&"undefined"!=typeof e.maxx&&"undefined"!=typeof e.maxy?this._mapInstance.fitBounds([[e.miny,e.minx],[e.maxy,e.maxx]]):"undefined"!=typeof e.getWest&&this._mapInstance.fitBounds(e))},fe.prototype.setBaseLayer=function(t){var r=this,e=null;if(t)e=Promise.resolve(t);else{var i=this.getService(p.ItemTypes.LAYER);e=C.get(i)}e.then(function(e){var t=oe.create(e);if(t){r._mapInstance.addLayer(t),t.setZIndex(0);var i=r._baseLayer;i&&r._mapInstance.removeLayer(i),r._baseLayer=t,r._baseLayerDef=e,r.touch("baselayer:changed",e,t)}else console.log("Warning: MapInstance could not create base layer for '"+e.id+"'")})["catch"](function(e){console.log("MapInstance.setBaseLayer() - Error getting base layer for map : "+e.message),r.logLayerError(t.id,"Error setting baselayer on map because of the following error(s): "+e.message)})},fe.prototype.getBaseLayer=function(){return this._baseLayerDef},fe.prototype.getLayers=function(){return this._layerStates},fe.prototype.getLayerErrors=function(){return this._layerErrors},fe.prototype.clearLayerErrors=function(){this._layerErrors=[],this.notify("layer:error")},fe.prototype.clearOverlays=function(){if(this._layerCache){for(var e=this._layerStates.length-1;0<=e;--e){var t=this._layerStates[e],i=this._layerCache[t.layer.id];i&&(i.off("layer:error"),this._layerCache[t.layer.id]=null,this._mapInstance.removeLayer(i))}this._layerStates=[],this.touch("layers:changed")}},fe.prototype.addLayers=function(n){var s=this;this._layerCache?this._layerCache?n&&("undefined"==typeof n.push&&(n=[n]),n.forEach(function(e,t){var i=null,r=null;if(e.type&&e.type===p.ItemTypes.LAYER?i=e:e.layer&&(i=e.layer,r=e),i){if(!s._layerCache[i.id]){if(!r)try{r={opacity:1,visibility:!0,layer:JSON.parse(JSON.stringify(i))}}catch(o){throw new Error("Unable to add layer to map because of "+o.message)}var a=n.length-t;r.zIndex=a,s.addLayerWithState(i,r)}}else console.log("MapInstance.addLayers() - layer ("+t+") is not a Layer or a Layer state. Ignoring...")}),this.touch("layers:changed")):console.log("WARN: Attempting to add layers to a map with no layer cache"):console.log("WARN: attempting to add layers to an empty cache")},fe.prototype.addLayerWithState=function(e,t){var i=this,r=null;try{if(!e||!t)throw new Error("Invalid argument, missing layer and or state");if(!(r=oe.create(e))){var a="Could not create leaflet instance for GP Layer '"+e.id+"'.";throw e.services&&e.services.length||(a+="  The layer instance has no services included, which will prevent most layers from being displayed."),new Error(a)}}catch(o){this.logLayerError(e.id,"Layer '"+e.label+"' could not be added to the map instance; "+o.message)}r&&(this._layerCache&&(this._layerCache[e.id]=r),r.on("tileerror",function(e){i.handleLayerError(e)}),this._mapInstance.addLayer(r),!isNaN(t.zIndex)&&r.setZIndex&&r.setZIndex(t.zIndex),this._layerStates.push(t),this.notify("layer:added",e,r),(!t.visibility||t.opacity<1)&&setTimeout(function(e,t){i.setLayerVisibility(e,t.visibility),i.setLayerOpacity(e,t.opacity)},2e3,r,t))},fe.prototype.moveLayer=function(e,t){if(this._layerCache&&this._layerCache&&!isNaN(e)){isNaN(t)&&(t=this._layerStates.length-1);var i=this._layerStates.splice(e,1)[0];this._layerStates.splice(t,0,i);for(var r=1,a=this._layerStates.length-1;0<=a;--a,++r){var o=this._layerStates[a],n=this._layerCache[o.layer.id];n&&(n.setZIndex(r),o.zIndex=r)}this.touch("layers:changed",this.getLayers())}},fe.prototype.removeLayer=function(e){if(this._layerCache){var t=this._layerCache[e];if(t){var i=this.getLayerStateIndex(e);0<=i&&i<this._layerStates.length&&this._layerStates.splice(i,1),t.off("layer:error"),this._mapInstance.removeLayer(t),this._layerCache[e]=null}this.touch("layers:changed")}},fe.prototype.toggleLayerVisibility=function(e){if(this._layerCache){var t=this._layerCache[e];if(t){var i=this.getLayerState(e);if(i.visibility=!i.visibility,t._currentImage)return t.setOpacity(i.visibility?1:0),void(i.opacity=t.getOpacity());this.setLayerVisibility(t,i.visibility)}}},fe.prototype.setLayerVisibility=function(e,t){e.setVisibility?e.setVisibility(t):e._container&&le(e._container).css({display:t?"":"none"}),this.touch("map:layer:changed")},fe.prototype.updateLayerOpacity=function(e,t){if(this._layerCache){var i=this._layerCache[e];i||this._baseLayerDef.id!==e||(i=this._baseLayer),t=this.setLayerOpacity(i,t);var r=this.getLayerState(e);r&&(r.opacity=t)}},fe.prototype.setLayerOpacity=function(e,t){return e&&e.setOpacity&&(1<t&&(t/=100),e.setOpacity(t),this.touch("map:layer:changed")),t},fe.prototype.getLeafletLayerFor=function(e){return e&&this._layerCache&&this._layerCache[e.id]||null},fe.prototype.toggleGetFeatureInfo=function(e){if(this._layerCache){var t=this._layerCache[e];t&&"undefined"!=typeof t.enableGetFeatureInfo&&(t.isGetFeatureInfoEnabled()?(t.disableGetFeatureInfo(),le(this._mapInstance._container).removeClass("selectable-cursor")):(t.enableGetFeatureInfo(),le(this._mapInstance._container).addClass("selectable-cursor")))}},fe.prototype.getFeatures=function(){return this._featureLayer?this._featureLayer.toGeoJSON().features:[]},fe.prototype.addFeatures=function(e){if(e)if("undefined"!=typeof e.push){for(var t=0;t<e.length;++t)this.addFeature(e[t],!1);this.touch("features:changed")}else e.features?this.addFeatures(e.features):this.addFeature(e,!0)},fe.prototype.addFeature=function(e,t){var i=this;this._featureLayer||(this._featureLayer=L.featureGroup().addTo(this._mapInstance));var r=le.extend({},this._geoJsonLayerOpts);L.geoJSON(e,r).eachLayer(function(e){return i.addFeatureLayer(e)}),void 0===t||!0===t?this.touch("features:changed"):this.touch()},fe.prototype.updateFeature=function(e){var t=this.getFeatureLayer(e.properties.id);if(t){t.feature=e,t.setStyle(e.properties.style);var i=e.properties.label||"Untitled "+e.geometry.type+" Feature";t.bindTooltip(i),this.touch("map:feature:changed")}},fe.prototype.replaceFeature=function(e){var t=this,i=this.getFeatureLayer(e.properties.id);i&&(this._featureLayer.removeLayer(i),L.geoJSON(e,this._geoJsonLayerOpts).eachLayer(function(e){return t.addFeatureLayer(e)}),this.touch("map:feature:changed"))},fe.prototype.focusFeature=function(e){var t=this.getFeatureLayer(e);if(t)if("undefined"!=typeof t.getBounds){var i=t.getBounds();this._mapInstance.fitBounds(i)}else if("undefined"!=typeof t.getLatLng){var r=t.getLatLng();this._mapInstance.panTo(r)}else console.log("MapInstance.focusFeature() - Cannot focus feature because it has no bounds or lat/lng");else console.log("MapInstance.focusFeature() - Cannot focus feature because it has no layer")},fe.prototype.removeFeature=function(e){var t=this.getFeatureLayer(e);t&&this._featureLayer&&(this._featureLayer.removeLayer(t),this.touch("features:changed"))},fe.prototype.removeFeatures=function(){this._featureLayer&&(this._featureLayer.clearLayers(),this.touch("features:changed"))},fe.prototype.getFeatureLayer=function(e){if(!e)return this._featureLayer;if(!this._featureLayer)return null;for(var t=this._featureLayer.getLayers(),i=0;i<t.length;++i)if(t[i].feature&&t[i].feature.properties.id===e)return t[i];return null},fe.prototype.toggleFeaturesLayer=function(){return!!this._featureLayer&&(this._featureLayerVisible=!this._featureLayerVisible,this.setFeatureLayerVisibility(this._featureLayer,this._featureLayerVisible),this._featureLayerVisible)},fe.prototype.setFeatureVisibility=function(e,t){this.setFeatureLayerVisibility(e,t)},fe.prototype.getFeaturesLayerVisibility=function(){return this._featureLayerVisible},fe.prototype.addFeatureLayer=function(e){this._addFeatureLayer(e),this.touch("features:changed")},fe.prototype._addFeatureLayer=function(e){var t=this;!e.feature&&e instanceof L.LayerGroup?e.eachLayer(function(e){t._addFeatureLayer(e)}):this._featureLayer.addLayer(e)},fe.prototype.setFeatureLayerVisibility=function(e,t){var i=this;if(e)if(this._featureLayerVisible=t,e.getLayers)e.getLayers().forEach(function(e){i.setFeatureLayerVisibility(e,t)});else{var r=e._container||e._path;r&&(r.style.display=t?"":"none")}},fe.prototype.save=function(e){return this.saveMap(e)},fe.prototype.saveMap=function(e){var r=this,t=e||{},i="http://www.geoplatform.gov/ont/openmap/GeoplatformMap";t.resourceTypes=t.resourceTypes||[],t.resourceTypes.indexOf(i)<0&&t.resourceTypes.push(i);var a=this.getMapResourceContent(t);return a.title&&a.title!==a.label?a.label=a.title:a.label&&!a.title&&(a.title=a.label),new Promise(function(t,i){r.getService(p.ItemTypes.MAP).save(a).then(function(e){r._mapId||(r._mapId=e.id),r._mapDef=e,r._defaultExtent=e.extent,r.clean(),t(e)})["catch"](function(e){console.log("MapCore MapInstance.saveMap() - The requested map could not be saved because: "+e.message);var t=new Error("The requested map could not be saved because of the following error(s): "+e.message);i(t)})})},fe.prototype.fetchMap=function(e){return this.getService(p.ItemTypes.MAP).get(e)},fe.prototype.loadMap=function(r){var a=this;return new Promise(function(t,i){a.fetchMap(r).then(function(e){if(!e)throw new Error("The requested map ('"+r+"') came back null");if("string"==typeof e)throw new Error("The requested map ('"+r+"') came back as a string");if(e.message)throw new Error("There was an error loading the requested map ('"+r+"'): "+e.message);"development"!==p.Config.env&&setTimeout(function(t){var e=[{op:"replace",path:"/statistics/numViews",value:(t.statistics&&t.statistics.numViews||0)+1}];a.getService(p.ItemTypes.MAP).patch(t.id,e).then(function(e){t.statistics=e.statistics})["catch"](function(e){console.log("MapInstance.saveMap() - Error updating view count for map ('"+r+"'): "+e)})},1e3,e),a.loadMapFromObj(e),t(e)})["catch"](function(e){console.log("MapInstance.loadMap() - The requested map could not be loaded because "+e.message);var t=new Error("The requested map ('"+r+"') could not be loaded because of the following error(s): "+e.message);i(t)})})},fe.prototype.loadMapFromObj=function(e){var t=this;this._mapId=e.id,(this._mapDef=e).extent=this.ensureExtent(e.extent),this._defaultExtent=e.extent;var i=e.extent;if(this._mapInstance.eachLayer(function(e){t._mapInstance.removeLayer(e)}),this._layerCache={},this._layerStates=[],this.setBaseLayer(e.baseLayer),this.addLayers(e.layers),e.annotations&&e.annotations.geoJSON){var r=e.annotations.geoJSON;r.features?this.addFeatures(r.features):this.addFeatures([r])}this._mapInstance.fitBounds([[i.miny,i.minx],[i.maxy,i.maxx]]),this.clean(),this.notify("map:loaded",e)},fe.prototype.ensureExtent=function(e){var t,i=!e||isNaN(e.minx)?-179:1*e.minx,r=!e||isNaN(e.maxx)?179:1*e.maxx,a=!e||isNaN(e.miny)?-89:1*e.miny,o=!e||isNaN(e.maxy)?89:1*e.maxy;return r<i&&(t=Math.min(i,r),r=Math.max(i,r),i=t),o<a&&(t=Math.min(a,o),o=Math.max(a,o),a=t),i<-180&&(i=-179),180<r&&(r=179),a<-90&&(a=-89),90<o&&(o=89),{minx:i,miny:a,maxx:r,maxy:o}},fe.prototype.destroyMap=function(){this._mapInstance=null,this._layerCache=null,this._layerStates=null,this._featureLayer=null},fe.prototype.setAsNewMap=function(e){this._mapId=null,this._mapDef=e||this.initializeMapDefinition()},fe.prototype.registerTool=function(e,t){this._tools[e]=t},fe.prototype.unregisterTool=function(e){this._tools[e]=null},fe.prototype.enableTool=function(e,t){if(!this._tools[e])return!1;this._tools[e].activate(function(){this.notify("tool:disabled",e)}),this.notify("tool:enabled",e)},fe.prototype.cacheMap=function(){this.state&&this.state.dirty&&(this.getMapResourceContent().layers=this._layerStates.slice(0))},fe.prototype.restoreMap=function(){},fe);function fe(e){var t=pe.call(this)||this;return t.setHttpClient(new p.XHRHttpClient),t.setServiceFactory(p.ServiceFactory),t._key=e||Math.ceil(9999*Math.random()),t._mapId=null,t._mapDef=t.initializeMapDefinition(),t._mapInstance=null,t._defaultExtent=null,t._baseLayerDef=null,t._baseLayer=null,t._layerStates=[],t._layerCache={},t._layerErrors=[],t._layerErrorHandler=function(e){console.log("MapInstance.defaultLayerErrorHandler() - "+e.id+" : "+e.message)},t._featureLayer=null,t._featureLayerVisible=!0,t._tools=[],t.state={dirty:!1},t._geoJsonLayerOpts={style:function(e){if(e.properties.style)return e.properties.style},onEachFeature:function(e,t){var i={weight:2,color:"#03f",opacity:.9,radius:4,fillColor:"#03f",fillOpacity:.5};~e.geometry.type.indexOf("Point")&&(i.fillOpacity=.9);var r=e.properties=e.properties||{};e.properties.id!==undefined&&null!==e.properties.id||(e.properties.id=Math.floor(999999*Math.random())),e.properties.label=r.label||r.title||r.name||"Untitled "+e.geometry.type+" Feature",e.properties.description=r.description||r.desc||"This feature needs a description!",e.properties.style=r.style||i,t.bindTooltip(r.label)},pointToLayer:function(e,t){var i=e.properties.style||{};return i.radius=i.radius||4,i.weight=i.weight||2,i.color=i.color||"#03f",i.opacity=i.opacity||.9,i.fillOpacity=i.opacity,i.fillColor=i.color,L.circleMarker(t,i)}},t}var de={},ye={get:function(e){if(e&&de[e])return de[e];var t=new he(e);return de[t._key]=t},dispose:function(e){e?(de[e].dispose(),delete de[e]):de=null}};!function ge(){"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),r=1;r<arguments.length;r++){var a=arguments[r];if(null!=a)for(var o in a)Object.prototype.hasOwnProperty.call(a,o)&&(i[o]=a[o])}return i},writable:!0,configurable:!0})}(),e.LoadingControl=o,e.MeasureControl=s,e.MousePositionControl=c,e.FeatureEditor=d,e.DefaultBaseLayer=C,e.LayerFactory=oe,e.OSMLayerFactory=re,e.BaseClusteredFeatureLayer=P,e.ClusteredFeatureLayer=R,e.clusteredFeatures=G,e.geoJsonFeed=k,e.FeatureLayer=se,e.WMS=N,e.wms=U,e.WMST=j,e.wmst=J,e.WMTS=K,e.wmts=Q,e.ESRITileLayer=ee,e.OSM=w,e.MapInstance=he,e.MapFactory=ye,e.ServiceTypes=x,e.PopupTemplate=F,e.StyleResolver=I,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=geoplatform-mapcore.umd.min.js.map