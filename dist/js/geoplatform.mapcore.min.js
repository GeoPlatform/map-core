"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){"function"==typeof define&&define.amd?define(["L"],function(r){return e.L_GeoPlatform=t(r)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.L_GeoPlatform=t(require("L")):GeoPlatform.L_GeoPlatform=t(L)}(window,function(e){if(!e)throw new Error("Missing Leaflet");return e.GeoPlatform||(e.GeoPlatform={}),void 0===Array.prototype.each&&(Array.prototype.each=function(e){for(var t=this,r=t.length,i=0;i<r;++i)try{e(t[i])}catch(e){}}),e.GeoPlatform}),function(e,t){"function"==typeof define&&define.amd?define(["q","L","GeoPlatform"],function(r,i,o){return e.FeatureStyleResolver=t(r,i,o)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.FeatureStyleResolver=t(require("q"),require("L"),require("GeoPlatform")):GeoPlatform.FeatureStyleResolver=t(Q,L,GeoPlatform)}(window,function(e,t,r){if(!t)throw new Error("Missing Leaflet");if(!t.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return t.GeoPlatform.featureStyleResolver=function(t){var i=e.defer();return jQuery.ajax({url:r.ualUrl+"/api/layers/"+t+"/style",dataType:"json",success:function(e){i.resolve(e)},error:function(e,r,o){var a="L.GeoPlatform.FeatureStyleResolver() -\n                   Error loading style information for layer "+t+" : "+o,n=new Error(a);i.reject(n)}}),i.promise},t.GeoPlatform.FeatureStyleResolver}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","L","GeoPlatform"],function(r,i,o){return e.featurePopupTemplate=t(r,i,o)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.featurePopupTemplate=t(require("jquery"),require("L"),require("GeoPlatform")):GeoPlatform.featurePopupTemplate=t(jQuery,L,GeoPlatform)}(window,function(e,t,r){if(!t)throw new Error("Missing Leaflet");if(!t.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return t.GeoPlatform.featurePopupTemplate=function(e){var t=Object.keys(e.properties),r=function(e,t){return e&&e.find?e.find(function(e){var r=e.toLowerCase();return t.indexOf(r)>=0}):null},i=r(t,["title","name","label"]),o=i?e.properties[i]:"Untitled",a=r(t,["description","summary","descript"]),n=a?e.properties[a]:"No description provided",s='<div class="feature-popup"><h5>'+o+"</h5><p>"+n+"</p>";if(e.properties.modified){s+='<div><span class="label">Updated</span><span class="value">'+new Date(e.properties.modified).toDateString()+"</span></div>"}if(e.properties["cap:effective"]){var l=new Date(e.properties["cap:effective"]);s+='<div><span class="label">Effective</span><span class="value">'+l.toDateString()+" "+l.toTimeString()+"</span></div>"}if(e.properties["cap:expires"]){var u=new Date(e.properties["cap:expires"]);s+='<div><span class="label">Expires</span><span class="value">'+u.toDateString()+" "+u.toTimeString()+"</span></div>"}var f=r(t,["landingpage","link","website"]);f&&(s+="<br>",s+='<a href="'+e.properties[f]+'" target="_blank">link</a>'),s+="<hr>";for(var c in e.properties)if(i!==c&&a!==c&&f!==c&&"modified"!==c){var h=e.properties[c];if("object"===(void 0===h?"undefined":_typeof(h)))for(var d in h)s+='<div><span class="label">'+c+"."+d+'</span><span class="value">'+h[d]+"</span></div>";else s+='<div><span class="label">'+c+'</span><span class="value">'+h+"</span></div>"}return s+="</div>"},t.GeoPlatform.featurePopupTemplate}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","GeoPlatform","ItemService","JQueryHttpClient","QueryFactory"],function(r,i,o,a,n,s){return e.ServiceTypes=t(r,i,o,a,n,s)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.ServiceTypes=t(require("jquery"),require("q"),require("GeoPlatform"),require("ItemService"),require("JQueryHttpClient"),require("QueryFactory")):GeoPlatform.ServiceTypes=t(jQuery,Q,GeoPlatform,GeoPlatform.ItemService,GeoPlatform.JQueryHttpClient,GeoPlatform.QueryFactory)}(window,function(e,t,r,i,o,a){var n=/OGC.+\(([A-Z\-]+)\)/,s=/Esri REST ([A-Za-z]+) Service/,l=function(e,t){var r=e.exec(t);return r&&r.length?r[1]:null},u={},f=a().types("dct:Standard").resourceTypes("ServiceType").pageSize(50);return new i(r.ualUrl,new o).search(f).then(function(e){for(var t=0;t<e.results.length;++t){var r=e.results[t],i=null,o=r.label;~o.indexOf("WMS-T")?(i="WMST",r.supported=!0):~o.indexOf("OGC")?(i=l(n,o),r.supported="WMS"===i||"WMTS"===i):~o.indexOf("Esri")?(i=l(s,o),r.supported=!0,i="ESRI_"+i.toUpperCase()+"_SERVER"):~o.indexOf("Feed")?(i="FEED",r.supported=!0):i=o,u[i]=r}}).catch(function(e){console.log("Error loading supported service types: "+e.message)}),u}),function(e,t){"function"==typeof define&&define.amd?define(["L"],function(r){return e.LoadingControl=t(r)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.LoadingControl=t(require("L")):GeoPlatform.LoadingControl=t(L)}(window,function(e){function t(e){e.Control.Loading=e.Control.extend({options:{position:"topleft",separate:!1,zoomControl:null,spinjs:!1,spin:{lines:7,length:3,width:3,radius:5,rotate:13,top:"83%"}},initialize:function(t){e.setOptions(this,t),this._dataLoaders={},null!==this.options.zoomControl&&(this.zoomControl=this.options.zoomControl)},onAdd:function(t){if(this.options.spinjs&&"function"!=typeof Spinner)return console.error("Leaflet.loading cannot load because you didn't load spin.js (http://fgnass.github.io/spin.js/), even though you set it in options.");this._addLayerListeners(t),this._addMapListeners(t),this.options.separate||this.zoomControl||(t.zoomControl?this.zoomControl=t.zoomControl:t.zoomsliderControl&&(this.zoomControl=t.zoomsliderControl));var r,i="leaflet-control-loading";return this.zoomControl&&!this.options.separate?(r=this.zoomControl._container,i+=" leaflet-bar-part-bottom leaflet-bar-part last"):r=e.DomUtil.create("div","leaflet-control-zoom leaflet-bar"),this._indicator=e.DomUtil.create("a",i,r),this.options.spinjs&&(this._spinner=new Spinner(this.options.spin).spin(),this._indicator.appendChild(this._spinner.el)),r},onRemove:function(e){this._removeLayerListeners(e),this._removeMapListeners(e)},removeFrom:function(t){return this.zoomControl&&!this.options.separate?(this._container.removeChild(this._indicator),this._map=null,this.onRemove(t),this):e.Control.prototype.removeFrom.call(this,t)},addLoader:function(e){this._dataLoaders[e]=!0,this.updateIndicator()},removeLoader:function(e){delete this._dataLoaders[e],this.updateIndicator()},updateIndicator:function(){this.isLoading()?this._showIndicator():this._hideIndicator()},isLoading:function(){return this._countLoaders()>0},_countLoaders:function(){var e,t=0;for(e in this._dataLoaders)this._dataLoaders.hasOwnProperty(e)&&t++;return t},_showIndicator:function(){e.DomUtil.addClass(this._indicator,"is-loading"),this.options.separate||(this.zoomControl instanceof e.Control.Zoom?e.DomUtil.removeClass(this.zoomControl._zoomOutButton,"leaflet-bar-part-bottom"):"function"==typeof e.Control.Zoomslider&&this.zoomControl instanceof e.Control.Zoomslider&&e.DomUtil.removeClass(this.zoomControl._ui.zoomOut,"leaflet-bar-part-bottom"))},_hideIndicator:function(){e.DomUtil.removeClass(this._indicator,"is-loading"),this.options.separate||(this.zoomControl instanceof e.Control.Zoom?e.DomUtil.addClass(this.zoomControl._zoomOutButton,"leaflet-bar-part-bottom"):"function"==typeof e.Control.Zoomslider&&this.zoomControl instanceof e.Control.Zoomslider&&e.DomUtil.addClass(this.zoomControl._ui.zoomOut,"leaflet-bar-part-bottom"))},_handleLoading:function(e){this.addLoader(this.getEventId(e))},_handleLoad:function(e){this.removeLoader(this.getEventId(e))},getEventId:function(e){return e.id?e.id:e.layer?e.layer._leaflet_id:e.target._leaflet_id},_layerAdd:function(e){if(e.layer&&e.layer.on)try{e.layer.on({loading:this._handleLoading,load:this._handleLoad},this)}catch(t){console.warn("L.Control.Loading: Tried and failed to add  event handlers to layer",e.layer),console.warn("L.Control.Loading: Full details",t)}},_addLayerListeners:function(e){e.eachLayer(function(e){e.on&&e.on({loading:this._handleLoading,load:this._handleLoad},this)},this),e.on("layeradd",this._layerAdd,this)},_removeLayerListeners:function(e){e.eachLayer(function(e){e.off&&e.off({loading:this._handleLoading,load:this._handleLoad},this)},this),e.off("layeradd",this._layerAdd,this)},_addMapListeners:function(e){e.on({dataloading:this._handleLoading,dataload:this._handleLoad,layerremove:this._handleLoad},this)},_removeMapListeners:function(e){e.off({dataloading:this._handleLoading,dataload:this._handleLoad,layerremove:this._handleLoad},this)}}),e.Map.addInitHook(function(){this.options.loadingControl&&(this.loadingControl=new e.Control.Loading,this.addControl(this.loadingControl))}),e.Control.loading=function(t){return new e.Control.Loading(t)}}return"function"==typeof define&&define.amd?define(["leaflet"],function(e){t(e)}):t(e),e.Control.Loading}),function(e,t){"function"==typeof define&&define.amd?define(["L"],function(r){return e.MeasureControl=t(r)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.MeasureControl=t(require("L")):GeoPlatform.MeasureControl=t(L)}(window,function(e){return e.Control.Measure=e.Control.extend({options:{position:"topleft"},onAdd:function(t){var r=e.DomUtil.create("div","leaflet-control-zoom leaflet-bar leaflet-control");return this._createButton("&#8674;","Measure","leaflet-control-measure leaflet-bar-part leaflet-bar-part-top-and-bottom",r,this._toggleMeasure,this),r},_createButton:function(t,r,i,o,a,n){var s=e.DomUtil.create("a",i,o);return s.innerHTML=t,s.href="#",s.title=r,e.DomEvent.on(s,"click",e.DomEvent.stopPropagation).on(s,"click",e.DomEvent.preventDefault).on(s,"click",a,n).on(s,"dblclick",e.DomEvent.stopPropagation),s},_toggleMeasure:function(){this._measuring=!this._measuring,this._measuring?(e.DomUtil.addClass(this._container,"leaflet-control-measure-on"),this._startMeasuring()):(e.DomUtil.removeClass(this._container,"leaflet-control-measure-on"),this._stopMeasuring())},_startMeasuring:function(){this._oldCursor=this._map._container.style.cursor,this._map._container.style.cursor="crosshair",this._doubleClickZoom=this._map.doubleClickZoom.enabled(),this._map.doubleClickZoom.disable(),e.DomEvent.on(this._map,"mousemove",this._mouseMove,this).on(this._map,"click",this._mouseClick,this).on(this._map,"dblclick",this._finishPath,this).on(document,"keydown",this._onKeyDown,this),this._layerPaint||(this._layerPaint=e.layerGroup().addTo(this._map)),this._points||(this._points=[])},_stopMeasuring:function(){this._map._container.style.cursor=this._oldCursor,e.DomEvent.off(document,"keydown",this._onKeyDown,this).off(this._map,"mousemove",this._mouseMove,this).off(this._map,"click",this._mouseClick,this).off(this._map,"dblclick",this._mouseClick,this),this._doubleClickZoom&&this._map.doubleClickZoom.enable(),this._layerPaint&&this._layerPaint.clearLayers(),this._restartPath()},_mouseMove:function(t){if(t.latlng&&this._lastPoint&&(this._layerPaintPathTemp?this._layerPaintPathTemp.spliceLatLngs(0,2,this._lastPoint,t.latlng):this._layerPaintPathTemp=e.polyline([this._lastPoint,t.latlng],{color:"black",weight:1.5,clickable:!1,dashArray:"6,3"}).addTo(this._layerPaint),this._tooltip)){this._distance||(this._distance=0),this._updateTooltipPosition(t.latlng);var r=t.latlng.distanceTo(this._lastPoint);this._updateTooltipDistance(this._distance+r,r)}},_mouseClick:function(t){if(t.latlng){if(this._lastPoint&&this._tooltip){this._distance||(this._distance=0),this._updateTooltipPosition(t.latlng);var r=t.latlng.distanceTo(this._lastPoint);this._updateTooltipDistance(this._distance+r,r),this._distance+=r}this._createTooltip(t.latlng),this._lastPoint&&!this._layerPaintPath&&(this._layerPaintPath=e.polyline([this._lastPoint],{color:"black",weight:2,clickable:!1}).addTo(this._layerPaint)),this._layerPaintPath&&this._layerPaintPath.addLatLng(t.latlng),this._lastCircle&&this._layerPaint.removeLayer(this._lastCircle),this._lastCircle=new e.CircleMarker(t.latlng,{color:"black",opacity:1,weight:1,fill:!0,fillOpacity:1,radius:2,clickable:!!this._lastCircle}).addTo(this._layerPaint),this._lastCircle.on("click",function(){this._finishPath()},this),this._lastPoint=t.latlng}},_finishPath:function(){this._lastCircle&&this._layerPaint.removeLayer(this._lastCircle),this._tooltip&&this._layerPaint.removeLayer(this._tooltip),this._layerPaint&&this._layerPaintPathTemp&&this._layerPaint.removeLayer(this._layerPaintPathTemp),this._restartPath()},_restartPath:function(){this._distance=0,this._tooltip=void 0,this._lastCircle=void 0,this._lastPoint=void 0,this._layerPaintPath=void 0,this._layerPaintPathTemp=void 0},_createTooltip:function(t){var r=e.divIcon({className:"leaflet-measure-tooltip",iconAnchor:[-5,-5]});this._tooltip=e.marker(t,{icon:r,clickable:!1}).addTo(this._layerPaint)},_updateTooltipPosition:function(e){this._tooltip.setLatLng(e)},_updateTooltipDistance:function(e,t){var r=this._round(e),i=this._round(t),o='<div class="leaflet-measure-tooltip-total">'+r+" nm</div>";i>0&&r!=i&&(o+='<div class="leaflet-measure-tooltip-difference">(+'+i+" nm)</div>"),this._tooltip._icon.innerHTML=o},_round:function(e){return Math.round(e/1852*10)/10},_onKeyDown:function(e){27==e.keyCode&&(this._lastPoint?this._finishPath():this._toggleMeasure())}}),e.Map.mergeOptions({measureControl:!1}),e.Map.addInitHook(function(){this.options.measureControl&&(this.measureControl=new e.Control.Measure,this.addControl(this.measureControl))}),e.control.measure=function(t){return new e.Control.Measure(t)},e.Control.Measure}),function(e,t){"function"==typeof define&&define.amd?define(["L"],function(r){return e.MousePositionControl=t(r)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.MousePositionControl=t(require("L")):GeoPlatform.MousePositionControl=t(L)}(window,function(e){return e.Control.MousePosition=e.Control.extend({options:{position:"bottomleft",separator:" : ",emptyString:"Unavailable",lngFirst:!1,numDigits:6,lngFormatter:void 0,latFormatter:void 0,prefix:""},onAdd:function(t){return this._container=e.DomUtil.create("div","leaflet-control-mouseposition"),e.DomEvent.disableClickPropagation(this._container),t.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(e){e.off("mousemove",this._onMouseMove)},_onMouseMove:function(t){var r=this.options.lngFormatter?this.options.lngFormatter(t.latlng.lng):e.Util.formatNum(t.latlng.lng,this.options.numDigits),i=this.options.latFormatter?this.options.latFormatter(t.latlng.lat):e.Util.formatNum(t.latlng.lat,this.options.numDigits),o=this.options.lngFirst?r+this.options.separator+i:i+this.options.separator+r,a=this.options.prefix+" "+o;this._container.innerHTML=a}}),e.Map.mergeOptions({positionControl:!1}),e.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new e.Control.MousePosition,this.addControl(this.positionControl))}),e.control.mousePosition=function(t){return new e.Control.MousePosition(t)},e.Control.MousePosition}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","L","GeoPlatform"],function(r,i,o,a){return e.WMSLayer=t(r,i,o,a)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.WMSLayer=t(require("jquery"),require("q"),require("L"),require("GeoPlatform")):GeoPlatform.WMSLayer=t(jQuery,Q,L,GeoPlatform)}(window,function(e,t,r,i){if(!r)throw new Error("Missing Leaflet");if(!r.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return r.GeoPlatform.WMS=r.TileLayer.WMS.extend({enableGetFeatureInfo:function(){this._map.on("click",this.getFeatureInfo,this),this._enabled=!0},disableGetFeatureInfo:function(){this._map.off("click",this.getFeatureInfo,this),this._enabled=!1},isGetFeatureInfoEnabled:function(){return this._enabled},onRemove:function(e){this.isGetFeatureInfoEnabled()&&this.disableGetFeatureInfo(),r.TileLayer.WMS.prototype.onRemove.call(this,e)},getFeatureInfo:function(t){var i=this.getFeatureInfoUrl(t.latlng),o=r.Util.bind(this.showGetFeatureInfo,this),a=this.parseGetFeatureInfo;e.ajax({url:i,success:function(e,r,i){"string"!=typeof e&&(e=a(e)),o(null,t.latlng,e)},error:function(e,t,r){o(r)}})},getFeatureInfoUrl:function(e){var t=this._map.latLngToContainerPoint(e,this._map.getZoom()),o=this._map.getSize(),a={srs:"EPSG:4326",bbox:this._map.getBounds().toBBoxString(),height:o.y,width:o.x,info_format:"text/xml",x:t.x,y:t.y,i:t.x,j:t.y},n="/api/layers/"+this.wmsParams.wmvId+"/feature";return i.ualUrl+n+r.Util.getParamString(a,n,!0)},parseGetFeatureInfo:function(e){var t=[];for(var r in e)t.push(["<div><strong>",r,": </strong>",e[r],"</div>"].join(" "));return 0==t.length&&t.push("<em>No data available</em>"),"<div>"+t.join(" ")+"</div>"},showGetFeatureInfo:function(e,t,i){if(e)return void console.log(e);r.popup({maxWidth:800}).setLatLng(t).setContent(i).openOn(this._map)}}),r.GeoPlatform.wms=function(e){var t=e.services&&e.services.length?e.services[0]:null;if(!t){throw new Error("L.GeoPlatform.wms() -\n                      Cannot create leaflet layer for GP Layer:\n                      layer has no service")}var o=t.href,a=e.supportedFormats?e.supportedFormats[0]:"image/png",n={layers:e.layerName,transparent:!0,format:a,wmvId:e.id};return i.leafletPane&&(n.pane=i.leafletPane),new r.GeoPlatform.WMS(o,n)},r.GeoPlatform.WMS}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","L","GeoPlatform"],function(r,i,o,a){return e.WMTSLayer=t(r,i,o,a)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.WMTSLayer=t(require("jquery"),require("q"),require("L"),require("GeoPlatform")):GeoPlatform.WMTSLayer=t(jQuery,Q,L,GeoPlatform)}(window,function(e,t,r,i){if(!r)throw new Error("Missing Leaflet");if(!r.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return r.GeoPlatform.WMTS=r.TileLayer.extend({defaultWmtsParams:{service:"WMTS",request:"GetTile",version:"1.0.0",layers:"",styles:"",tileMatrixSet:"",format:"image/png"},initialize:function(e,t){this._url=e;var i=r.extend({},this.defaultWmtsParams),o=t.tileSize||this.options.tileSize;t.detectRetina&&r.Browser.retina?i.width=i.height=2*o:i.width=i.height=o;for(var a in t)this.options.hasOwnProperty(a)||"matrixIds"==a||(i[a]=t[a]);this.wmtsParams=i,this.matrixIds=t.matrixIds||this.getDefaultMatrix(),r.setOptions(this,t)},onAdd:function(e){this._crs=this.options.crs||e.options.crs,r.TileLayer.prototype.onAdd.call(this,e)},getTileUrl:function(e){var t=this.options.tileSize,i=e.multiplyBy(t);i.x+=1,i.y-=1;var o=i.add(new r.Point(t,t)),a=this._tileZoom,n=this._crs.project(this._map.unproject(i,a)),s=this._crs.project(this._map.unproject(o,a)),l=s.x-n.x,u=this.matrixIds[a].identifier,f=(this.wmtsParams.tileMatrixSet,this.matrixIds[a].topLeftCorner.lng),c=this.matrixIds[a].topLeftCorner.lat,h=Math.floor((n.x-f)/l),d=-Math.floor((n.y-c)/l),y=this._url,p=y.indexOf("{TileMatrix}"),m=y.indexOf("{TileRow}"),_=y.indexOf("{TileCol}"),v={s:this._getSubdomain(e)};p>0&&(v.TileMatrix=u),m>0&&(v.TileRow=d),_>0&&(v.TileCol=h),y=r.Util.template(y,v);var g=y.indexOf("?");return g<0||p<g&&m<g||_<g||(y+=r.Util.getParamString(this.wmtsParams,y),p<0&&(y+="&TileMatrix="+u),m<0&&(y+="&TileRow="+d),_<0&&(y+="&TileCol="+h)),y},setParams:function(e,t){return r.extend(this.wmtsParams,e),t||this.redraw(),this},getDefaultMatrix:function(){for(var e=new Array(22),t=0;t<22;t++)e[t]={identifier:""+t,topLeftCorner:new r.LatLng(20037508.3428,-20037508.3428)};return e}}),r.GeoPlatform.wmts=function(e){var t=e.services&&e.services.length?e.services[0].href:null,o={layer:e.layerName,style:"default",tileMatrixSet:"default",format:"image/png"};i.leafletPane&&(o.pane=i.leafletPane);var a=(e.distributions||[]).find(function(e){return e.href&&("image/png"===e.mediaType||"image/jpeg"===e.mediaType)});if(a){t=a.href,o.format=a.mediaType;(a.parameters||[]).each(function(e){var r=e.defaultValue||e.values&&e.values.length&&e.values[0];null!==r&&void 0!==r&&(t=t.replace("{"+e.name+"}",r))})}if(!t)throw new Error("Unable to get URL for layer "+e.id);return new r.GeoPlatform.WMTS(t,o)},r.GeoPlatform.WMTS}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","L","GeoPlatform"],function(r,i,o,a){return e.WMSTLayer=t(r,i,o,a)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.WMSTLayer=t(require("jquery"),require("q"),require("L"),require("GeoPlatform")):GeoPlatform.WMSTLayer=t(jQuery,Q,L,GeoPlatform)}(window,function(e,t,r,i){if(!r)throw new Error("Missing Leaflet");if(!r.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return r.GeoPlatform.WMST=r.TimeDimension.Layer.WMS.extend({_parseTimeDimensionFromCapabilities:function(e){var t=e.querySelectorAll("Layer"),r=this._baseLayer.wmsParams.layers,i=null,o=null;return t.forEach(function(e){e.querySelector("Name").innerHTML===r&&(i=e)}),i&&((o=this._getTimesFromLayerCapabilities(i))||(o=this._getTimesFromLayerCapabilities(i.parentNode))),o},_getTimesFromLayerCapabilities:function(e){var t=null,r=e.querySelectorAll("Dimension[name='time']");if(r&&r.length&&r[0].textContent.length&&(t=r[0].textContent.trim()),!t||!t.length){var i=e.querySelectorAll("Extent[name='time']");i&&i.length&&i[0].textContent.length&&(t=i[0].textContent.trim())}return t&&~t.indexOf("current")&&(t=t.replace("current",(new Date).toISOString())),t}}),r.GeoPlatform.wmst=function(e){var t=e.services[0],o=t.href,a={layers:e.layerName,transparent:!0,format:"image/png",wmvId:e.layerId};i.leafletPane&&(a.pane=i.leafletPane);var n=new r.TileLayer.CustomWMS(o,a),s=i.ualUrl+"/api/services/"+t.id+"/proxy/capabilities",l={};if(e.temporal){var u=e.temporal.startDate?new Date(e.temporal.startDate):new Date,f=e.temporal.endDate?new Date(e.temporal.endDate):new Date;l.times=u.toISOString()+"/"+f.toISOString()+"/P1D"}return new r.GeoPlatform.WMST(n,{timeDimension:r.timeDimension(l),proxy:s})},r.GeoPlatform.WMST}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","L","GeoPlatform"],function(r,i,o,a){return e.ESRITileLayer=t(r,i,o,a)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.ESRITileLayer=t(require("jquery"),require("q"),require("L"),require("GeoPlatform")):GeoPlatform.ESRITileLayer=t(jQuery,Q,L,GeoPlatform)}(window,function(e,t,r,i){if(!r)throw new Error("Missing Leaflet");if(!r.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return r.TileLayer.ESRI=r.TileLayer.extend({defaultESRIParams:{layers:"",transparent:!0,format:"png32",f:"image"},initialize:function(e,t){if(e.indexOf("/export")<0){var i=e.indexOf("?");i>0?e=e.substring(0,i)+"/export"+e.substring(i):e+="/export"}this._url=e;var o=r.extend({},this.defaultESRIParams),a=t.tileSize||this.options.tileSize,n=void 0;n=t.detectRetina&&r.Browser.retina?o.height=2*a:o.height=a,o.size=n+","+n;for(var s in t)this.options.hasOwnProperty(s)||"crs"===s||(o[s]=t[s]);this.esriParams=o,r.setOptions(this,t)},onAdd:function(e){this._crs=this.options.crs||e.options.crs,this.esriParams.srs=this.esriParams.imagesr=this.esriParams.bboxsr=this._crs.code,r.TileLayer.prototype.onAdd.call(this,e)},getTileUrl:function(e){var t=this._map,i=this.options.tileSize,o=e.multiplyBy(i),a=o.add([i,i]),n=this._crs.project(t.unproject(o,e.z)),s=this._crs.project(t.unproject(a,e.z)),l=[n.x,s.y,s.x,n.y].join(","),u=r.Util.template(this._url,{s:this._getSubdomain(e)}),f=r.extend({},this.esriParams);return f.layers="show:"+f.layers,"EPSG:3857"===f.bboxsr&&(f.bboxsr="102100"),"EPSG:3857"===f.imagesr&&(f.imagesr="102100"),u+r.Util.getParamString(f,u,!0)+"&BBOX="+l},setParams:function(e,t){return r.extend(this.esriParams,e),t||this.redraw(),this}}),r.tileLayer.esri=function(e,t){return new r.TileLayer.ESRI(e,t)},r.TileLayer.ESRI}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","L","GeoPlatform"],function(r,i,o,a){return e.FeatureLayer=t(r,i,o,a)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.FeatureLayer=t(require("jquery"),require("q"),require("L"),require("GeoPlatform")):GeoPlatform.FeatureLayer=t(jQuery,Q,L,GeoPlatform)}(window,function(e,t,r,i){if(!r)throw new Error("Missing Leaflet");if(!r.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return r.GeoPlatform.FeatureLayer=r.esri.FeatureLayer.extend({_gpStyle:{color:"#00f",weight:2,fillColor:"#00f",fillOpacity:.3},pointToLayerFn:function(e,t){var o=e&&e.properties?e.properties.style:null;if(!o&&"function"==typeof this.options.style)try{o=this.options.style(e)}catch(e){console.log("error using style function in ClusteredFeatureLayer: "+e.message)}o=o||this.options.style||{};var a=null;if("image"===o.shape){var n=o.width||16,s=o.height||16,l=r.icon({iconUrl:o.content,iconSize:[n,s],iconAnchor:[.5*n,.5*s],popupAnchor:[0,-11]});a=r.marker(t,{icon:l,pane:i.leafletPane})}else o.radius=o.radius||o["stroke-width"]||4,o.weight=o.weight||o["stroke-width"]||2,o.color=o.color||o.stroke||"#03f",o.opacity=o.opacity||o["stroke-opacity"]||.9,o.fillOpacity=o.opacity||o["fill-opacity"]||.3,o.fillColor=o.color||o.fill,o.renderer=this.options.renderer,a=r.circleMarker(t,o);var u=this.options.popupTemplate||r.GeoPlatform.featurePopupTemplate;return a.bindPopup(u(e)),a},eachFeatureFn:function(e,t){e&&e.geometry&&"Point"!==e.geometry.type&&t.bindPopup(r.GeoPlatform.featurePopupTemplate(e))},initialize:function(e){var t=this;e=e||{},i.leafletPane&&(e.pane=i.leafletPane);e.style=e.style||function(){return t._gpStyle}();var o={};i.leafletPane&&(o.pane=i.leafletPane);var a=r.SVG&&r.svg(o)||r.Canvas&&r.canvas();e.renderer=a,e.pointToLayer=r.bind(this.pointToLayerFn,this),e.onEachFeature=r.bind(this.eachFeatureFn,this),r.esri.FeatureLayer.prototype.initialize.call(this,e),this.on("load",function(){void 0!==this.options.zIndex&&this.setZIndex(this.options.zIndex)})},setZIndex:function(e){this.options.zIndex=e;for(var t in this._layers)this._layers[t].setZIndex(e)},toggleVisibility:function(){for(var e in this._layers){this._layers[e].toggleVisibility&&this._layers[e].toggleVisibility()}},setOpacity:function(e){for(var t in this._layers){var r=this._layers[t];r.setOpacity&&r.setOpacity(e)}},loadStyle:function(t){var i=this;this.options.styleLoader&&this.options.styleLoader(t).then(function(t){if(t){var o=null;if(t&&t.styles){var a=r.Util.bind(function(e){var t=this.property||this.field1,r=e[t]||(e.properties?e.properties[t]:null),i=null;if(this.styles){var o=this.styles.find(function(e){return e.value===r});o&&(i=o.style,i.radius=i.radius||i["stroke-width"]||4,i.weight=i.weight||i["stroke-width"]||2,i.color=i.color||i.stroke||"#03f",i.opacity=i.opacity||i["stroke-opacity"]||.9,i.fillOpacity=i.opacity||i["fill-opacity"]||.3,i.fillColor=i.color||i.fill)}return i},t);return i.options.style=a,void i.setStyle(a)}if(t&&void 0!==t.push)o=t[0];else{if(!t)return;o=t}if(o.shape){var n=e.extend({},o);n.style=o,i._gpStyle=o;for(var s in i._layers)i._layers[s].setStyle(n)}}}).catch(function(e){console.log("Error fetching feature layer style"),console.log(e)})}}),r.GeoPlatform.FeatureLayer}),function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports,require("leaflet"),require("esri-leaflet")):"function"==typeof define&&define.amd?define(["exports","leaflet","esri-leaflet"],t):t((e.L=e.L||{},e.L.esri=e.L.esri||{},e.L.esri.Cluster=e.L.esri.Cluster||{}),e.L,e.L.esri)}(window,function(e,t,r){function i(e){return new o(e)}t="default"in t?t.default:t;var o=r.FeatureManager.extend({statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose",CLUSTEREVENTS:"clusterclick clusterdblclick clustermouseover clustermouseout clustermousemove clustercontextmenu"},initialize:function(e){r.FeatureManager.prototype.initialize.call(this,e),e=t.setOptions(this,e),this._layers={},this._leafletIds={},this.cluster=t.markerClusterGroup(e),this._key="c"+(1e9*Math.random()).toString(36).replace(".","_"),this.cluster.addEventParent(this)},onAdd:function(e){r.FeatureManager.prototype.onAdd.call(this,e),this._map.addLayer(this.cluster)},onRemove:function(e){r.FeatureManager.prototype.onRemove.call(this,e),this._map.removeLayer(this.cluster)},createLayers:function(e){for(var r=[],i=e.length-1;i>=0;i--){var o=e[i];if(!this._layers[o.id]){var a=t.GeoJSON.geometryToLayer(o,this.options);a.feature=t.GeoJSON.asFeature(o),a.defaultOptions=a.options,a._leaflet_id=this._key+"_"+o.id,this.resetStyle(a.feature.id),this._layers[a.feature.id]=a,this._leafletIds[a._leaflet_id]=o.id,this.options.onEachFeature&&this.options.onEachFeature(a.feature,a),this.fire("createfeature",{feature:a.feature}),(!this.options.timeField||this.options.timeField&&this._featureWithinTimeRange(o))&&r.push(a)}}r.length&&this.cluster.addLayers(r)},addLayers:function(e){for(var t=[],r=e.length-1;r>=0;r--){var i=this._layers[e[r]];this.fire("addfeature",{feature:i.feature}),t.push(i)}this.cluster.addLayers(t)},removeLayers:function(e,t){for(var r=[],i=e.length-1;i>=0;i--){var o=e[i],a=this._layers[o];this.fire("removefeature",{feature:a.feature,permanent:t}),r.push(a),this._layers[o]&&t&&delete this._layers[o]}this.cluster.removeLayers(r)},resetStyle:function(e){var t=this._layers[e];return t&&(t.options=t.defaultOptions,this.setFeatureStyle(t.feature.id,this.options.style)),this},setStyle:function(e){return this.eachFeature(function(t){this.setFeatureStyle(t.feature.id,e)},this),this},setFeatureStyle:function(e,t){var r=this._layers[e];"function"==typeof t&&(t=t(r.feature)),r.setStyle&&r.setStyle(t)},eachFeature:function(e,t){for(var r in this._layers)e.call(t,this._layers[r]);return this},getFeature:function(e){return this._layers[e]}});e.FeatureLayer=o,e.featureLayer=i,e.default=i,e.VERSION="2.0.0"}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","L","GeoPlatform"],function(r,i,o,a){return e.ClusteredFeatureLayer=t(r,i,o,a)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.ClusteredFeatureLayer=t(require("jquery"),require("q"),require("L"),require("GeoPlatform")):GeoPlatform.ClusteredFeatureLayer=t(jQuery,Q,L,GeoPlatform)}(window,function(e,t,r,i){if(!r)throw new Error("Missing Leaflet");if(!r.GeoPlatform)throw new Error("Missing GeoPlatform extensions to Leaflet");return r.GeoPlatform.ClusteredFeatureLayer=r.esri.Cluster.FeatureLayer.extend({_gpStyle:{color:"#00f",weight:2,fillColor:"#00f",fillOpacity:.3},pointToLayerFn:function(e,t){var o=e&&e.properties?e.properties.style:null
;if(!o&&"function"==typeof this.options.style)try{o=this.options.style(e)}catch(e){console.log("error using style function in ClusteredFeatureLayer: "+e.message)}o=o||this.options.style||{},o.radius=o["stroke-width"]||o.radius||4,o.weight=o["stroke-width"]||o.weight||2,o.color=o.stroke||o.color||"#03f",o.opacity=o["stroke-opacity"]||o.opacity||.9,o.fillOpacity=o["fill-opacity"]||o.opacity||.3,o.fillColor=o.fill||o.color||"#03f",o.renderer=this.options.renderer;var a=null;if("image"===o.shape){var n=o.width||16,s=o.height||16,l=r.icon({iconUrl:o.content,iconSize:[n,s],iconAnchor:[.5*n,.5*s],popupAnchor:[0,-11]});a=r.marker(t,{icon:l,pane:i.leafletPane})}else a=r.circleMarker(t,o);var u=this.options.popupTemplate||r.GeoPlatform.featurePopupTemplate;return a.bindPopup(u(e)),a},eachFeatureFn:function(e,t){e&&e.geometry&&"Point"!==e.geometry.type&&t.bindPopup(r.GeoPlatform.featurePopupTemplate(e))},initialize:function(e){var t=this;e=e||{},i.leafletPane&&(e.pane=i.leafletPane),e.pointToLayer=r.bind(this.pointToLayerFn,this),e.onEachFeature=r.bind(this.eachFeatureFn,this),e.spiderfyDistanceMultiplier=2;var o=function(){return t._gpStyle};e.style=e.style||o,e.styleResolver&&(this.styleResolver=e.styleResolver);var a={};i.leafletPane&&(a.pane=i.leafletPane);var n=r.SVG&&r.svg(a)||r.Canvas&&r.canvas();e.renderer=n,r.esri.Cluster.FeatureLayer.prototype.initialize.call(this,e),this.on("load",function(){void 0!==this.options.zIndex&&this.setZIndex(this.options.zIndex)})},onAdd:function(e){r.esri.Cluster.FeatureLayer.prototype.onAdd.call(this,e),this.options.layerId&&this.loadStyle(this.options.layerId)},setZIndex:function(e){this.options.zIndex=e;for(var t in this._layers)this._layers[t].setZIndex(e)},toggleVisibility:function(){if(this.cluster&&this.cluster._featureGroup&&this.cluster._featureGroup._layers)for(var t in this.cluster._featureGroup._layers){var r=this.cluster._featureGroup._layers[t];r._icon&&e(r._icon).toggleClass("invisible")}if(this._layers)for(var i in this._layers)this._layers[i].toggleVisibility()},setVisibility:function(t){if(this.cluster&&this.cluster._featureGroup&&this.cluster._featureGroup._layers)for(var r in this.cluster._featureGroup._layers){var i=this.cluster._featureGroup._layers[r];if(i._icon){var o=e(i._icon);t?o.removeClass("invisible"):o.addClass("invisible")}}if(this._layers)for(var a in this._layers){var n=this._layers[a];n.setVisibility?n.setVisibility(t):n.setStyle&&n.setStyle({display:t?"":"none"})}},setOpacity:function(t){if(this.cluster&&this.cluster._featureGroup&&this.cluster._featureGroup._layers)for(var r in this.cluster._featureGroup._layers){var i=this.cluster._featureGroup._layers[r];i._icon&&e(i._icon).css({opacity:t})}if(this._layers)for(var o in this._layers){var a=this._layers[o];a.setOpacity&&a.setOpacity(t)}},setStyle:function(e){this.eachFeature(function(t){this.setFeatureStyle(t.feature.id,e)},this)},loadStyle:function(t){var i=this;this.options.styleLoader&&this.options.styleLoader(t).then(function(t){if(t){var o=null;if(t&&t.styles){var a=r.Util.bind(function(e){var t=this.property||this.field1,r=e[t]||(e.properties?e.properties[t]:null),i=null;if(this.styles){var o=this.styles.find(function(e){return e.value===r});o?(i=o.style,i.radius=i["stroke-width"]||i.radius||4,i.weight=i["stroke-width"]||i.weight||2,i.color=i.stroke||i.color||"#03f",i.opacity=i["stroke-opacity"]||i.opacity||.9,i.fillOpacity=i["fill-opacity"]||i.opacity||.3,i.fillColor=i.fill||i.color||"#03f"):console.log("No matching style for "+JSON.stringify(e.properties))}return i},t);return i.options.style=a,void setTimeout(function(e,t){e.setStyle(t)},1e3,i,a)}if(t&&void 0!==t.push)o=t[0];else{if(!t)return;o=t}if(o.shape){var n=e.extend({},o);n.style=o,i._gpStyle=o;for(var s in i._layers)i._layers[s].setStyle(n)}}}).catch(function(e){console.log("Error fetching feature layer style"),console.log(e)})}}),r.GeoPlatform.clusteredFeatures=function(e){var t=e.services&&e.services.length?e.services[0]:null;if(!t){throw new Error("L.GeoPlatform.clusteredFeatures() -\n                      Cannot create leaflet layer for GP Layer:\n                      layer has no service")}var o=t.href;e.supportedFormats&&e.supportedFormats[0];return new r.GeoPlatform.ClusteredFeatureLayer({url:o+"/"+e.layerName,styleLoader:r.GeoPlatform.FeatureStyleResolver,layerId:e.id,pane:i.leafletPane})},r.GeoPlatform.geoJsonFeed=function(o){var a=o.services&&o.services.length?o.services[0]:null;if(!a){throw new Error("L.GeoPlatform.geoJsonFeed() -\n                      Cannot create leaflet layer for GP Layer:\n                      layer has no service")}var n=a.href,s=(o.supportedFormats&&o.supportedFormats[0],n+("/"===n[n.length-1]?"":"/")+o.id+"/FeatureServer/"+o.layerName),l=n.replace("feeds","styles")+("/"===n[n.length-1]?"":"/")+o.id;return new r.GeoPlatform.ClusteredFeatureLayer({url:s,isModern:!0,layerId:o.id,styleLoader:function(r){return function(i){var o=t.defer();return e.ajax(r,{dataType:"json",success:function(e){o.resolve(e)},error:function(e,t,r){var a="L.GeoPlatform.geoJsonFeed() -\n                            Error loading style information for layer "+i+" : "+r,n=new Error(a);o.reject(n)}}),o.promise}}(l),pane:i.leafletPane})},r.GeoPlatform.ClusteredFeatureLayer}),function(e,t){"function"==typeof define&&define.amd?define(["q","GeoPlatform","QueryFactory","LayerService","JQueryHttpClient"],function(r,i,o,a,n){return e.OSM=t(r,i,o,a,n)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.OSM=t(require("q"),require("GeoPlatform"),require("QueryFactory"),require("LayerService"),require("JQueryHttpClient")):GeoPlatform.OSM=t(Q,GeoPlatform,GeoPlatform.QueryFactory,GeoPlatform.LayerService,GeoPlatform.JQueryHttpClient)}(window,function(e,t,r,i,o){return{test:function(e){return e&&e.resourceTypes&&e.resourceTypes.length&&~e.resourceTypes.indexOf("http://www.geoplatform.gov/ont/openlayer/OSMLayer")},get:function(a){var n=r().fields("*").resourceTypes("http://www.geoplatform.gov/ont/openlayer/OSMLayer");return a||(a=new i(t.ualUrl,new o)),a.search(n).then(function(e){return e.results.length?e.results[0]:null}).catch(function(t){return e.reject(t)})}}}),function(e,t){"function"==typeof define&&define.amd?define(["q","GeoPlatform","OSM","LayerService","JQueryHttpClient"],function(r,i,o,a,n){return e.defaultBaseLayer=t(r,i,o,a,n)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.defaultBaseLayer=t(require("q"),require("GeoPlatform"),require("OSM"),require("LayerService"),require("JQueryHttpClient")):GeoPlatform.defaultBaseLayer=t(Q,GeoPlatform,GeoPlatform.OSM,GeoPlatform.LayerService,GeoPlatform.JQueryHttpClient)}(window,function(e,t,r,i,o){return function(a){return t.defaultBaseLayerId?(a||(a=new i(t.ualUrl,new o)),a.get(t.defaultBaseLayerId).catch(function(t){return e.resolve(r.get())})):r.get()}}),function(e,t){"function"==typeof define&&define.amd?define(["q","L","GeoPlatform","ServiceTypes","OSM"],function(r,i,o,a,n){return e.LayerFactory=t(r,i,o,a,n)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.LayerFactory=t(require("q"),require("L"),require("GeoPlatform"),require("ServiceTypes"),require("OSM")):GeoPlatform.LayerFactory=t(Q,L,GeoPlatform,GeoPlatform.ServiceTypes,GeoPlatform.OSM)}(window,function(e,t,r,i,o){return t.GeoPlatform.osm=function(e){return new t.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{minZoom:1,maxZoom:19,attribution:'Map data (c) <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'})},t.GeoPlatform.LayerFactory=function(e){if(!e)throw new Error("\n                L.GeoPlatform.LayerFactory() -\n                Invalid argument: must provide a layer object\n            ");if(o.test(e))return t.GeoPlatform.osm(e);if(!e.services||!e.services.length)throw new Error("\n                L.GeoPlatform.LayerFactory() -\n                Cannot create Leaflet layer for GP Layer "+e.id+",\n                layer has no services defined!\n            ");var a=e.services[0],n=a.href,s=a.serviceType.uri,l=e.supportedCRS?e.supportedCRS[0]:null,u=e.supportedFormats?e.supportedFormats[0]:null,f={};switch(s){case i.ESRI_MAP_SERVER.uri:return f={layers:e.layerName,transparent:!0,format:u||"png32"},l&&(f.srs=l),r.leafletPane&&(f.pane=r.leafletPane),t.tileLayer.esri(n,f);case i.ESRI_FEATURE_SERVER.uri:return t.GeoPlatform.clusteredFeatures(e);case i.ESRI_TILE_SERVER.uri:return f={url:n,useCors:!0},r.leafletPane&&(f.pane=r.leafletPane),t.esri.tiledMapLayer(f);case i.FEED.uri:return t.GeoPlatform.geoJsonFeed(e);case i.WMS.uri:return t.GeoPlatform.wms(e);case i.WMST.uri:return t.GeoPlatform.wmst(e);case i.WMTS.uri:return t.GeoPlatform.wmts(e);case i.WFS.uri:case i.WCS.uri:default:return null}},t.GeoPlatform.LayerFactory}),function(e,t){"function"==typeof define&&define.amd?define(["jquery","q","L","GeoPlatform","OSM","ItemTypes","ServiceFactory","JQueryHttpClient"],function(r,i,o,a,n,s,l,u){return e.MapInstance=t(r,i,o,a,n,s,l,u)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.MapInstance=t(require("jquery"),require("q"),require("L"),require("GeoPlatform"),require("OSM"),require("ItemTypes"),require("ServiceFactory"),require("JQueryHttpClient")):GeoPlatform.MapInstance=t(jQuery,Q,L,GeoPlatform,GeoPlatform.OSM,GeoPlatform.ItemTypes,GeoPlatform.ServiceFactory,GeoPlatform.JQueryHttpClient)}(window,function(e,t,r,i,o,a,n,s){var l=function(){function e(){_classCallCheck(this,e),this._listeners={}}return _createClass(e,[{key:"on",value:function(e,t){this._listeners[e]||(this._listeners[e]=[]),this._listeners[e].push(t)}},{key:"off",value:function(e,t){if(e||(this._listeners={}),this._listeners[e])if(t){var r=this._listeners[e].indexOf(t);r>=0&&this._listeners[e].splice(r,1)}else this._listeners[e]=[]}},{key:"notify",value:function(e){if(this._listeners[e]){var t=Array.prototype.slice.call(arguments,1);this._listeners[e].each(function(e){e.apply(null,t)})}}}]),e}();return function(l){function u(e){_classCallCheck(this,u);var t=_possibleConstructorReturn(this,(u.__proto__||Object.getPrototypeOf(u)).call(this));return t.setHttpClient(new s),t.setServiceFactory(n),t._key=e||Math.ceil(9999*Math.random()),t._mapId=null,t._mapDef=t.initializeMapDefinition(),t._mapInstance=null,t._defaultExtent=null,t._baseLayerDef=null,t._baseLayer=null,t._layerStates=[],t._layerCache={},t._layerErrors=[],t._featureLayer=null,t._featureLayerVisible=!0,t._tools=[],t.state={dirty:!1},t._geoJsonLayerOpts={style:function(e){if(e.properties.style)return e.properties.style},onEachFeature:function(e,t){var r={weight:2,color:"#03f",opacity:.9,radius:4,fillColor:"#03f",fillOpacity:.5};~e.geometry.type.indexOf("Point")&&(r.fillOpacity=.9);var i=e.properties=e.properties||{};e.properties.id=Math.floor(999999*Math.random()),e.properties.label=i.label||i.title||i.name||"Untitled "+e.geometry.type+" Feature",e.properties.description=i.description||i.desc||"This feature needs a description!",e.properties.style=i.style||r,t.bindTooltip(i.label)},pointToLayer:function(e,t){var i=e.properties.style||{};return i.radius=i.radius||4,i.weight=i.weight||2,i.color=i.color||"#03f",i.opacity=i.opacity||.9,i.fillOpacity=i.opacity,i.fillColor=i.color,r.circleMarker(t,i)}},t}return _inherits(u,l),_createClass(u,[{key:"dispose",value:function(){this.destroyMap(),this.svcCache=null,this.serviceFactory=null,this.httpClient=null,this._key=null,this._mapId=null,this._mapDef=null,this._mapInstance=null,this._defaultExtent=null,this._baseLayerDef=null,this._baseLayer=null,this._layerStates=null,this._layerCache=null,this._layerErrors=null,this._featureLayer=null,this._featureLayerVisible=!0,this._tools=null,this.state=null,this._geoJsonLayerOpts=null}},{key:"getKey",value:function(){return this._key}},{key:"setService",value:function(e){}},{key:"setServiceFactory",value:function(e){this.svcCache={},this.serviceFactory=e}},{key:"setHttpClient",value:function(e){this.svcCache={},this.httpClient=e}},{key:"getService",value:function(e){return this.svcCache[e]||(this.svcCache[e]=this.serviceFactory(e,i.ualUrl,this.httpClient)),this.svcCache[e]}},{key:"getLayerStateIndex",value:function(e){if(!e)return-1;for(var t=0;t<this._layerStates.length;++t)if(this._layerStates[t].layer&&e===this._layerStates[t].layer.id)return t;return-1}},{key:"getLayerState",value:function(e){var t=this.getLayerStateIndex(e);return t>=0?_layerStates[t]:null}},{key:"initializeMapDefinition",value:function(){return{type:a.MAP,title:"My New Map",label:"My New Map",description:"This map needs a description",createdBy:null,baseLayer:this._baseLayerDef,layers:[],keywords:[],themes:[],resourceTypes:["http://www.geoplatform.gov/ont/openmap/GeoplatformMap"]}}},{key:"getMapResourceContent",value:function(e){e=e||{},e.layers=this._layerStates.slice(0),e.baseLayer=this._baseLayerDef,e.annotations=this._featureLayer?{title:"Map Features",geoJSON:this._featureLayer.toGeoJSON()}:null;var t=this._mapInstance.getBounds();return e.extent={minx:t.getWest(),miny:t.getSouth(),maxx:t.getEast(),maxy:t.getNorth()},e}},{key:"getDrawControlToolbar",value:function(){if(!this._mapInstance.drawControl)return null;var e=this._mapInstance.drawControl._toolbars,t=null;for(var r in e)if(e.hasOwnProperty(r)&&e[r]._modes){t=e[r];break}return t}},{key:"handleLayerError",value:function(e){var t=e.target;for(var r in this._layerCache)if(this._layerCache[r]===t){this.processLayerError(e,r);break}}},{key:"processLayerError",value:function(e,t){var r=this,i=function(e){return e.id===t};if(!this._layerErrors.find(i)){var o={id:t,message:"Layer failed to completely load. It may be inaccessible or misconfigured."};this._layerErrors.push(o);var a=e.tile.src,n={id:t};a.substring(a.indexOf("?")+1,a.length).split("&").each(function(e){var t=e.split("=");n[t[0]]=t[1]}),this.layerService.validate(t,n).catch(function(e){var t=r._layerStates.find(i);o.message="Layer '"+t.label+"' failed to completely load. It may be inaccessible or misconfigured. Reported cause: "+e.message,r.notify("layer:error",o)})}}},{key:"addFeatureLayer",value:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){!e.feature&&e instanceof r.LayerGroup?e.eachLayer(addFeatureLayer):this._featureLayer.addLayer(e)})},{key:"setFeatureLayerVisibility",value:function(e){function t(t,r){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e,t){if(e)if(e.getLayers)e.getLayers().each(function(e){setFeatureLayerVisibility(e,t)});else{var r=e._container||e._path;r&&(r.style.display=t?"":"none")}})},{key:"touch",value:function(e){this.state.dirty=!0,e&&(arguments.length>1?this.notify.apply(this,Array.prototype.slice.call(arguments)):this.notify(e))}},{key:"clean",value:function(){this.state.dirty=!1}},{key:"setMap",value:function(e){this._mapInstance=e}},{key:"getMap",value:function(){return this._mapInstance}},{key:"getMapDefinition",value:function(){return this._mapDef}},{key:"getMapId",value:function(){return this._mapId}},{key:"setView",value:function(e,t,r){var i=r;void 0===i&&(i=this._mapInstance.getZoom()),this._mapInstance.setView([e,t],i),this.touch("map:view:changed")}},{key:"getView",value:function(){var e=this._mapInstance.getCenter();return[e.lat,e.lng]}},{key:"getZoom",value:function(){return this._mapInstance.getZoom()}},{key:"zoomToDefault",value:function(){this._defaultExtent?this._mapInstance.fitBounds([[this._defaultExtent.miny,this._defaultExtent.minx],[this._defaultExtent.maxy,this._defaultExtent.maxx]]):this._mapInstance.setView([38,-96],5),this.touch("map:view:changed")}},{key:"setBaseLayer",value:function(e){var i=this,a=null;a=e?t.resolve(e):o.get(),a.then(function(e){var t=r.GeoPlatform.LayerFactory(e);if(t){i._mapInstance.addLayer(t),t.setZIndex(0);var o=i._baseLayer;o&&i._mapInstance.removeLayer(o),i._baseLayer=t,i._baseLayerDef=e,i.touch("baselayer:changed",e)}}).catch(function(t){console.log("MapInstance.setBaseLayer() - Error getting base layer for map : "+t.message),i._layerErrors.push({id:e.id,message:t.message})})}},{key:"getBaseLayer",value:function(){return this._baseLayerDef}},{key:"getLayers",value:function(){return this._layerStates}},{key:"getLayerErrors",value:function(){return this._layerErrors}},{key:"clearLayerErrors",value:function(){this._layerErrors=[],this.notify("layer:error")}},{key:"clearOverlays",value:function(){for(var e=this._layerStates.length-1;e>=0;--e){var t=this._layerStates[e],r=this._layerCache[t.layer.id];r&&(r.off("layer:error"),this._layerCache[t.layer.id]=null,this._mapInstance.removeLayer(r))}this._layerStates=[],this.touch("layers:changed")}},{key:"addLayers",value:function(e){var t=this;e.each(function(r,i){var o=null,a=null;if(r.id?o=r:r.layer&&(o=r.layer,a=r),o&&!t._layerCache[o.id]){a||(a={opacity:1,visibility:!0,layer:JSON.parse(JSON.stringify(o))});var n=e.length-i;a.zIndex=n,t.addLayerWithState(o,a)}}),this.touch("layers:changed")}},{key:"addLayerWithState",value:function(e,t){var i=this,o=null;try{if(!e||!t)throw new Error("Invalid argument, missing layer and or state");if(!(o=r.GeoPlatform.LayerFactory(e)))throw new Error("Layer factory returned nothing")}catch(t){this._layerErrors.push({id:e.id,message:"MapInstance.addLayerWithState() - Could not create a Leaflet layer: "+t.message})}o&&(o.on("tileerror",this.handleLayerError),this._layerCache[e.id]=o,this._mapInstance.addLayer(o),!isNaN(t.zIndex)&&o.setZIndex&&o.setZIndex(t.zIndex),this._layerStates.push(t),(!t.visibility||t.opacity<1)&&setTimeout(function(e,t){i.setLayerVisibility(e,t.visibility),i.setLayerOpacity(e,t.opacity)},500,o,t))}},{key:"moveLayer",value:function(e,t){if(!isNaN(e)){isNaN(t)&&(t=this._layerStates.length-1);var r=this._layerStates.splice(e,1)[0];this._layerStates.splice(t,0,r);for(var i=1,o=this._layerStates.length-1;o>=0;--o,++i){var a=this._layerStates[o],n=this._layerCache[a.layer.id];n&&(n.setZIndex(i),a.zIndex=i)}this.touch("layers:changed",this.getLayers())}}},{key:"removeLayer",value:function(e){var t=this._layerCache[e];if(t){var r=this.getLayerStateIndex(e);this._layerStates.splice(r,1),t.off("layer:error"),this._mapInstance.removeLayer(t),this._layerCache[e]=null}this.touch("layers:changed")}},{key:"toggleLayerVisibility",value:function(e){var t=this._layerCache[e];if(t){var r=this.getLayerState(e);if(r.visibility=!r.visibility,t._currentImage)return t.setOpacity(r.visibility?1:0),void(r.opacity=t.getOpacity());this.setLayerVisibility(t,r.visibility)}}},{key:"setLayerVisibility",value:function(t,r){if(t.setVisibility)t.setVisibility(r);else if(t._container){var i=e(t._container);r?i.removeClass("invisible"):i.addClass("invisible")}this.touch("map:layer:changed")}},{key:"updateLayerOpacity",value:function(e,t){var r=this._layerCache[e];r||this._baseLayerDef.id!==e||(r=this._baseLayer),t=this.setLayerOpacity(r,t);var i=this.getLayerState(e);i&&(i.opacity=t)}},{key:"setLayerOpacity",value:function(e,t){return e&&e.setOpacity&&(t>1&&(t/=100),e.setOpacity(t),this.touch("map:layer:changed")),t}},{key:"getLeafletLayerFor",value:function(e){return e?this._layerCache[e.id]||null:null}},{key:"toggleGetFeatureInfo",value:function(t){var r=this._layerCache[t];r&&void 0!==r.enableGetFeatureInfo&&(r.isGetFeatureInfoEnabled()?(r.disableGetFeatureInfo(),e(_mapInstance._container).removeClass("selectable-cursor")):(r.enableGetFeatureInfo(),e(_mapInstance._container).addClass("selectable-cursor")))}},{key:"getFeatures",value:function(){return this._featureLayer?this._featureLayer.toGeoJSON().features:[]}},{key:"addFeatures",value:function(e){if(e)if(void 0!==e.push){for(var t=0;t<e.length;++t)this.addFeature(e[t],!1);this.touch("features:changed")}else e.features?this.addFeatures(e.features):this.addFeature(e,!0)}},{key:"addFeature",value:function(t,i){var o=this;this._featureLayer||(this._featureLayer=r.featureGroup().addTo(this._mapInstance));var a=e.extend({},this._geoJsonLayerOpts);r.geoJson(t,a).eachLayer(function(e){return o.addFeatureLayer(e)}),void 0===i||!0===i?this.touch("features:changed"):this.touch()}},{key:"updateFeature",value:function(e){var t=this.getFeatureLayer(e.properties.id);if(t){t.feature=e,t.setStyle(e.properties.style);var r=e.properties.label||"Untitled "+e.geometry.type+" Feature";t.bindTooltip(r),this.touch("map:feature:changed")}}},{key:"replaceFeature",value:function(e){var t=this,i=this.getFeatureLayer(e.properties.id);i&&(this._featureLayer.removeLayer(i),r.geoJson(e,this._geoJsonLayerOpts).eachLayer(function(e){return t.addFeatureLayer(e)}),this.touch("map:feature:changed"))}},{key:"focusFeature",value:function(e){var t=this.getFeatureLayer(e);if(t){var r=t.getBounds();this._mapInstance.fitBounds(r)}}},{key:"removeFeature",value:function(e){var t=this.getFeatureLayer(e);t&&this._featureLayer&&(this._featureLayer.removeLayer(t),this.touch("features:changed"))}},{key:"removeFeatures",value:function(){this._featureLayer&&(this._featureLayer.clearLayers(),this.touch("features:changed"))}},{key:"getFeatureLayer",value:function(e){if(!this._featureLayer)return null;for(var t=this._featureLayer.getLayers(),r=0;r<t.length;++r)if(t[r].feature.properties.id===e)return t[r];return null}},{key:"toggleFeaturesLayer",value:function(){return!!this._featureLayer&&(this._featureLayerVisible=!this._featureLayerVisible,this.setFeatureLayerVisibility(this._featureLayer,this._featureLayerVisible),this._featureLayerVisible)}},{key:"setFeatureVisibility",value:function(e,t){this.setFeatureLayerVisibility(e,t)}},{key:"getFeaturesLayerVisibility",value:function(){return this._featureLayerVisible}},{key:"save",value:function(e){return this.saveMap(e)}},{key:"saveMap",value:function(e){var r=this,i=e||{},o="http://www.geoplatform.gov/ont/openmap/GeoplatformMap";i.resourceTypes=i.resourceTypes||[],i.resourceTypes.indexOf(o)<0&&i.resourceTypes.push(o);var n=this.getMapResourceContent(i);return n.title&&n.title!==n.label?n.label=n.title:n.label&&!n.title&&(n.title=n.label),this.getService(a.MAP).save(n).then(function(e){return r._mapId||(r._mapId=e.id),r._mapDef=e,r._defaultExtent=e.extent,r.clean(),e}).catch(function(e){var r=new Error("MapInstance.saveMap() - The requested map could not be saved because: "+e.message);return t.reject(r)})}},{key:"fetchMap",value:function(e){return this.getService(a.MAP).get(e)}},{key:"loadMap",value:function(e){var r=this;return this.fetchMap(e).then(function(e){if(!e)throw new Error("The requested map came back null");if("string"==typeof e)throw new Error("The requested map came back as a string");if(e.message)throw new Error("There was an error loading the requested map: "+e.message);return"development"!==i.env&&setTimeout(function(e){var t=e.statistics?e.statistics.numViews||0:0,i=[{op:"replace",path:"/statistics/numViews",value:t+1}];r.getService(a.MAP).patch(e.id,i).then(function(t){e.statistics=t.statistics}).catch(function(e){console.log("Error updating view count for map: "+e)})},1e3,e),r.loadMapFromObj(e),e}).catch(function(e){var r=new Error("MapInstance.loadMap() - The requested map could not be loaded because "+e.message);return t.reject(r)})}},{key:"loadMapFromObj",value:function(e){var t=this;this._mapId=e.id,this._mapDef=e;var r;r=Math.min(e.extent.minx,e.extent.maxx),e.extent.maxx=Math.max(e.extent.minx,e.extent.maxx),e.extent.minx=r,r=Math.min(e.extent.miny,e.extent.maxy),e.extent.maxy=Math.max(e.extent.miny,e.extent.maxy),e.extent.miny=r,e.extent.minx<-180&&(e.extent.minx=-179),e.extent.maxx>180&&(e.extent.maxx=179),e.extent.miny<-90&&(e.extent.miny=-89),e.extent.maxy>90&&(e.extent.maxy=89),this._defaultExtent=e.extent;var i=e.extent;if(this._mapInstance.eachLayer(function(e){t._mapInstance.removeLayer(e)}),this._layerCache={},this._layerStates=[],this.setBaseLayer(e.baseLayer),this.addLayers(e.layers),e.annotations&&e.annotations.geoJSON){var o=e.annotations.geoJSON;o.features?this.addFeatures(o.features):this.addFeatures([o])}this._mapInstance.fitBounds([[i.miny,i.minx],[i.maxy,i.maxx]]),this.clean(),this.notify("map:loaded",e)}},{key:"destroyMap",value:function(){this._mapInstance=null,this._layerCache=null,this._layerStates=null,this._featureLayer=null}},{key:"setAsNewMap",value:function(e){this._mapId=null,this._mapDef=e||this.initializeMapDefinition()}},{key:"registerTool",value:function(e,t){this._tools[e]=t}},{key:"unregisterTool",value:function(e){this._tools[e]=null}},{key:"enableTool",value:function(e,t){if(!this._tools[e])return!1;this._tools[e].activate(function(){this.notify("tool:disabled",e)}),this.notify("tool:enabled",e)}},{key:"cacheMap",value:function(){if(state.dirty){this.getMapResourceContent().layers=this._layerStates.slice(0)}}},{key:"restoreMap",value:function(){}}]),u}(l)}),function(e,t){"function"==typeof define&&define.amd?define(["MapInstance"],function(r){return e.MapInstance=t(r)}):"object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports?module.exports=e.MapInstance=t(require("MapInstance")):GeoPlatform.MapFactory=t(GeoPlatform.MapInstance)}(window,function(e){var t={};return{get:function(r){if(r&&t[r])return t[r];var i=new e(r);return t[i._key]=i,i},dispose:function(e){e?(t[e].destroyMap(),delete t[e]):t=null}}});