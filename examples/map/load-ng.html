<!DOCTYPE html>
<html ng-app="loadNG">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <base href="/">
    <title>Angular Load Map Example</title>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="src/control/L.Control.Loading.css" />
    <style type="text/css">
        #map { width: 400px; height: 300px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div id="map">
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.5.1/q.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.0/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/esri-leaflet/2.1.2/esri-leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.3.0/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-timedimension@1.1.0/dist/leaflet.timedimension.src.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.js"></script>

    <!-- environment settings -->
    <script>
        GeoPlatform = {
            ualUrl : 'https://sit-ual.geoplatform.us',
            env: 'development' //to prevent bumping map's numViews
        };
    </script>

    <script src="dist/js/geoplatform.mapcore.js"></script>

    <script>

        angular.module('loadNG', []).config(function myAppConfig ($httpProvider) {
            $httpProvider.defaults.withCredentials = true;
        });

        let elem = document.getElementById('map');
        let mapOptions = {
            center: [38, -96],
            zoom: 5,
            minZoom: 2,
            maxZoom: 21,
            maxBounds: [[-90,-180],[90,180]],
            tap: true,
            touchZoom:true,
            loadingControl: true
        };

        let leafletMap = L.map(elem, mapOptions);
        let mapInstance = L.GeoPlatform.MapFactory();
        mapInstance.setMap(leafletMap);

        //use Angular-based MapService instead of default (JQuery)
        let service = new GeoPlatform.NGMapService();
        mapInstance.setService(service);

        //just for example purposes, find the first map available
        let query = GeoPlatform.QueryFactory().keywords('WMV');

        service.search(query)
        .then( response => {
            if(response.results.length) {

                //Note: search results do not contain resolved
                // references to properties such as layers and
                // layer services, so we need to specifically
                // fetch the individual map to load it.
                // Can either use MapService.get(id) and
                // then MapInstance.loadMapFromObj(map) or
                // just use MapInstance.loadMap(id);
                let map = response.results[0];

                //either this...
                mapInstance.loadMap(map.id);

                //or this
                service.get(map.id)
                .then( fullMap => {
                    mapInstance.loadMapFromObj(fullMap);
                }).catch(e => { console.log(e.message); });

            }
        })
        .catch(e => { console.log(e.message); });


    </script>

</body>
</html>
